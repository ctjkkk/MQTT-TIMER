# æ±‰å¥‡æ™ºèƒ½çŒæº‰ç³»ç»Ÿ - ç¡¬ä»¶å¯¹æ¥æ–‡æ¡£ v2.0

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 2.0
**æ›´æ–°æ—¥æœŸï¼š** 2025-01-26

---

## 1. ç³»ç»Ÿæ¶æ„

```
å­è®¾å¤‡ <--RF--> ç½‘å…³ <--MQTT/TLS--> äº‘ç«¯ <--HTTP--> App
```

- ç½‘å…³ï¼šä¸­å¿ƒèŠ‚ç‚¹ï¼Œè´Ÿè´£WiFiã€MQTTé€šä¿¡
- å­è®¾å¤‡ï¼šæ°´é˜€ç­‰ç»ˆç«¯ï¼Œé€šè¿‡RFä¸ç½‘å…³é€šä¿¡
- äº‘ç«¯ï¼šMQTT Brokerã€æ•°æ®å­˜å‚¨

---

## 2. PSKç”Ÿäº§æµç¨‹

### 2.1 å·¥å‚çƒ§å½•

**æ­¥éª¤1ï¼šç”Ÿæˆå¯†é’¥å¯¹**

```http
POST /api/psk/generate
Content-Type: application/json

{
  "macAddress": "AABBCCDDEEFF"
}
```

è¿”å›ï¼š

```json
{
  "identity": "AABBCCDDEEFF",
  "key": "a1b2c3d4...ï¼ˆ128ä½åå…­è¿›åˆ¶ï¼‰"
}
```

**æ­¥éª¤2ï¼šçƒ§å½•åˆ°Flash**

å°† `identity` å’Œ `key` æ°¸ä¹…å­˜å‚¨åˆ°è®¾å¤‡Flashã€‚

**æ­¥éª¤3ï¼šç¡®è®¤çƒ§å½•**

```http
POST /api/psk/confirm
Content-Type: application/json

{
  "macAddress": "AABBCCDDEEFF"
}
```

**æ³¨æ„ï¼š** åªæœ‰ç¡®è®¤åï¼Œè®¾å¤‡æ‰èƒ½è¿æ¥MQTTã€‚

### 2.2 è®¾å¤‡ä½¿ç”¨

è®¾å¤‡å‡ºå‚åï¼Œè¿æ¥MQTTæ—¶ä»Flashè¯»å– `identity` å’Œ `key`ï¼Œä½¿ç”¨PSK-TLSè®¤è¯ã€‚

---

## 3. MQTTè¿æ¥å‚æ•°

| å‚æ•°     | å€¼                              |
| -------- | ------------------------------- |
| åè®®     | mqtts:// (MQTT over TLS)        |
| ç«¯å£     | 8445ï¼ˆç”Ÿäº§ï¼‰/ 1885ï¼ˆæµ‹è¯•ï¼ŒTCPï¼‰ |
| è®¤è¯     | PSK (identity + key)            |
| ClientID | `gateway_{MACåœ°å€}`             |
| ç¤ºä¾‹     | `gateway_AABBCCDDEEFF`          |

**è®¢é˜…Topicï¼š**

```
hanqi/gateway/{ç½‘å…³MAC}/command
```

---

## 4. Topicè®¾è®¡

| Topic                             | æ–¹å‘      | ç”¨é€”     |
| --------------------------------- | --------- | -------- |
| `hanqi/gateway/{ç½‘å…³MAC}/report`  | ç½‘å…³â†’äº‘ç«¯ | æ•°æ®ä¸ŠæŠ¥ |
| `hanqi/gateway/{ç½‘å…³MAC}/command` | äº‘ç«¯â†’ç½‘å…³ | å‘½ä»¤ä¸‹å‘ |

---

## 5. æ¶ˆæ¯æ ¼å¼

æ‰€æœ‰æ¶ˆæ¯ä½¿ç”¨ç»Ÿä¸€JSONç»“æ„ï¼š

```json
{
  "msgType": "æ¶ˆæ¯ç±»å‹",
  "msgId": "æ¶ˆæ¯IDï¼ˆå¯é€‰ï¼‰",
  "deviceId": "ç½‘å…³MAC",
  "subDeviceId": "å­è®¾å¤‡IDï¼ˆå¯é€‰ï¼‰",
  "timestamp": 1737900000,
  "data": {}
}
```

### 5.1 æ¶ˆæ¯ç±»å‹

| msgType           | æ–¹å‘      | è¯´æ˜                     | çŠ¶æ€ |
| ----------------- | --------- | ------------------------ | ---- |
| `heartbeat`       | ç½‘å…³â†’äº‘ç«¯ | å¿ƒè·³ï¼ˆ30ç§’é—´éš”ï¼‰         | âœ…   |
| `heartbeat_ack`   | äº‘ç«¯â†’ç½‘å…³ | å¿ƒè·³å“åº”ï¼ˆæºå¸¦ç»‘å®šçŠ¶æ€ï¼‰ | âœ…   |
| `operate_devices` | åŒå‘      | è®¾å¤‡ç”Ÿå‘½å‘¨æœŸç®¡ç†         | âœ…   |
| `dp_report`       | ç½‘å…³â†’äº‘ç«¯ | DPç‚¹æ•°æ®ä¸ŠæŠ¥             | ğŸ”„   |
| `dp_command`      | äº‘ç«¯â†’ç½‘å…³ | DPç‚¹å‘½ä»¤ä¸‹å‘             | ğŸ”„   |

---

## 6. é…ç½‘æµç¨‹

```
Appæ‰«æè“ç‰™ â†’ å‘é€WiFié…ç½® â†’ ç½‘å…³è¿WiFi â†’ è¿MQTT â†’ å‘é€æ³¨å†Œæ¶ˆæ¯ â†’ Appè½®è¯¢éªŒè¯ â†’ Appç»‘å®šç½‘å…³
```

### 6.1 ç½‘å…³æ³¨å†Œ

Topic: `hanqi/gateway/AABBCCDDEEFF/report`

```json
{
  "msgType": "operate_devices",
  "deviceId": "AABBCCDDEEFF",
  "timestamp": 1737900000,
  "data": {
    "entityType": "gateway",
    "action": "gateway_register",
    "firmware": "1.0.0",
    "model": "HQ-GW-100"
  }
}
```

### 6.2 å¿ƒè·³ä¸ŠæŠ¥ï¼ˆæºå¸¦çŠ¶æ€ï¼‰

Topic: `hanqi/gateway/AABBCCDDEEFF/report`

```json
{
  "msgType": "heartbeat",
  "deviceId": "AABBCCDDEEFF",
  "timestamp": 1737900030,
  "data": {
    "entityType": "gateway"
    // å¯æºå¸¦çš„çŠ¶æ€å‚æ•°ï¼ˆå¾…è¡¥å……ï¼‰ï¼š
    // "wifi_rssi": -45,          // WiFiä¿¡å·å¼ºåº¦
    // "memory_usage": 45,        // å†…å­˜å ç”¨
    // "firmware": "1.0.0",       // å›ºä»¶ç‰ˆæœ¬
    // ...å…¶ä»–å‚æ•°
  }
}
```

**ä¸ŠæŠ¥é¢‘ç‡ï¼š** 30ç§’

**å»ºè®®æºå¸¦çš„çŠ¶æ€ï¼ˆè¯·åé¦ˆå“ªäº›å¯ä»¥æä¾›ï¼‰ï¼š**

- WiFiä¿¡å·å¼ºåº¦ï¼ˆRSSIï¼‰
- å†…å­˜å ç”¨
- CPUå ç”¨
- å›ºä»¶ç‰ˆæœ¬
- å…¶ä»–ä½ ä»¬è®¤ä¸ºæœ‰å¿…è¦çš„çŠ¶æ€æ•°æ®

### 6.3 å¿ƒè·³å“åº”

Topic: `hanqi/gateway/AABBCCDDEEFF/command`

```json
{
  "msgType": "heartbeat_ack",
  "deviceId": "AABBCCDDEEFF",
  "timestamp": 1737900030,
  "data": {
    "status": 1,
    "userId": "507f1f77bcf86cd799439011"
  }
}
```

**å­—æ®µè¯´æ˜ï¼š**

- `status`: 1=å·²ç»‘å®šï¼Œ0=æœªç»‘å®š
- `userId`: ç”¨æˆ·IDï¼Œæœªç»‘å®šæ—¶ä¸ºnull

**ç½‘å…³å¤„ç†ï¼š**

- æ£€æµ‹åˆ° `status=0` ä¸”ä¹‹å‰ä¸º1ï¼Œè¯´æ˜ç”¨æˆ·è§£ç»‘äº†ç½‘å…³
- æ¸…é™¤æœ¬åœ°ç”¨æˆ·é…ç½®ï¼Œè¿›å…¥å¾…ç»‘å®šçŠ¶æ€

---

## 7. å­è®¾å¤‡ç®¡ç†ï¼ˆæ¡†æ¶ï¼‰

### 7.1 æ·»åŠ å­è®¾å¤‡

Topic: `hanqi/gateway/AABBCCDDEEFF/report`

```json
{
  "msgType": "operate_devices",
  "deviceId": "AABBCCDDEEFF",
  "timestamp": 1737900400,
  "data": {
    "entityType": "subDevice",
    "action": "subdevice_add",
    "subDevices": [
      {
        "subDeviceId": "timer_001",
        "deviceType": 1,
        "capabilities": 0,
        "productId": 1001,
        "firmwareVersion": "1.0.0",
        "online": true,
        "private": "è®¾å¤‡ç§æœ‰æ•°æ®"
      }
    ]
  }
}
```

### 7.2 DPç‚¹ä¸ŠæŠ¥

Topic: `hanqi/gateway/AABBCCDDEEFF/report`

```json
{
  "msgType": "dp_report",
  "deviceId": "AABBCCDDEEFF",
  "subDeviceId": "timer_001",
  "timestamp": 1737900500,
  "data": {
    "dps": {
      "111": true,
      "105": 85,
      "106": -65
    }
  }
}
```

### 7.3 DPç‚¹å‘½ä»¤

Topic: `hanqi/gateway/AABBCCDDEEFF/command`

```json
{
  "msgType": "dp_command",
  "deviceId": "AABBCCDDEEFF",
  "subDeviceId": "timer_001",
  "timestamp": 1737900600,
  "data": {
    "dps": {
      "111": false,
      "112": 600
    }
  }
}
```

### 7.4 DPç‚¹å®šä¹‰ï¼ˆè§„åˆ’ï¼‰

**æ°´é˜€é€šç”¨å±æ€§ï¼š**

| DP ID | åç§°     | ç±»å‹   | è¯´æ˜      |
| ----- | -------- | ------ | --------- |
| 101   | ç”µæ± ç”µé‡ | VALUE  | 0-100%    |
| 102   | RFä¿¡å·   | VALUE  | RSSIå€¼    |
| 105   | å›ºä»¶ç‰ˆæœ¬ | STRING | å¦‚"1.0.0" |

**ç¬¬1è·¯å‡ºæ°´å£ï¼š**

| DP ID | åç§°     | ç±»å‹  | è¯´æ˜                   |
| ----- | -------- | ----- | ---------------------- |
| 111   | å¼€å…³     | BOOL  | true=å¼€ï¼Œfalse=å…³      |
| 112   | å€’è®¡æ—¶   | VALUE | å•ä½ï¼šç§’               |
| 113   | å‰©ä½™æ—¶é—´ | VALUE | å•ä½ï¼šç§’               |
| 114   | å·¥ä½œçŠ¶æ€ | ENUM  | 0=ç©ºé—²ï¼Œ1=æµ‡æ°´ï¼Œ2=æš‚åœ |

**å…¶ä»–å‡ºæ°´å£ï¼š**

- ç¬¬2è·¯ï¼šDP 131-134
- ç¬¬3è·¯ï¼šDP 151-154
- ç¬¬4è·¯ï¼šDP 171-174

---

## 8. ç½‘å…³ç”Ÿå‘½å‘¨æœŸ

### 8.1 é‡å¯

Topic: `hanqi/gateway/AABBCCDDEEFF/command`

```json
{
  "msgType": "operate_devices",
  "deviceId": "AABBCCDDEEFF",
  "timestamp": 1737900800,
  "data": {
    "entityType": "gateway",
    "action": "gateway_reboot"
  }
}
```

### 8.2 æ¢å¤å‡ºå‚

Topic: `hanqi/gateway/AABBCCDDEEFF/report`

```json
{
  "msgType": "operate_devices",
  "deviceId": "AABBCCDDEEFF",
  "timestamp": 1737900900,
  "data": {
    "entityType": "gateway",
    "action": "gateway_reset",
    "reason": "factory_reset"
  }
}
```

å‘é€åæ¸…é™¤WiFié…ç½®å’Œç”¨æˆ·æ•°æ®ï¼Œä¿ç•™PSKå¯†é’¥ã€‚

---

## 9. åœ¨çº¿æ£€æµ‹

**åœ¨çº¿æ¡ä»¶ï¼š**

- MQTTè¿æ¥æ­£å¸¸
- æœ€åå¿ƒè·³åœ¨60ç§’å†…

**ç¦»çº¿è§¦å‘ï¼š**

- MQTTæ–­å¼€
- è¶…è¿‡60ç§’æœªæ”¶åˆ°å¿ƒè·³

**ç½‘å…³è¦æ±‚ï¼š**

- å¿ƒè·³30ç§’é—´éš”ï¼Œä¸¥æ ¼æ‰§è¡Œ
- æ–­çº¿è‡ªåŠ¨é‡è¿
- é‡è¿åç«‹å³å‘é€å¿ƒè·³

---

---

## 11. æµ‹è¯•ç¯å¢ƒ

**MQTT Brokerï¼š**

- åœ°å€ï¼š`35.172.194.174`
- PSKç«¯å£ï¼š`8445`
- TCPç«¯å£ï¼š`1885`

**HTTP APIï¼š**

- åœ°å€ï¼š`http://35.172.194.174:8018/api`
- Swaggerï¼š`http://35.172.194.174:8018/doc.html`

---

## 12. å…³é”®è¦æ±‚

### 12.1 å¿…é¡»å®ç°

- ClientIDæ ¼å¼ï¼š`gateway_{MAC}`ï¼Œæ— æ—¶é—´æˆ³
- å¿ƒè·³30ç§’é—´éš”ï¼Œæºå¸¦WiFiä¿¡å·ç­‰çŠ¶æ€
- æ¥æ”¶å¿ƒè·³å“åº”ï¼Œå¤„ç†ç»‘å®šçŠ¶æ€å˜åŒ–
- PSKå¯†é’¥å®‰å…¨å­˜å‚¨ï¼Œä¸å¯è¯»å–
- NTPå¯¹æ—¶ï¼Œæ¥æ”¶äº‘ç«¯æ—¶åŒº
- å®Œæ•´é…ç½‘æµç¨‹

### 12.2 æ¶ˆæ¯æ ¼å¼

- å­—æ®µåä¸¥æ ¼åŒºåˆ†å¤§å°å†™
- `timestamp` ä¸ºUnixæ—¶é—´æˆ³ï¼ˆç§’ï¼‰
- `deviceId` ä¸ºMACåœ°å€ï¼ˆæ— å†’å·ï¼‰
- JSONæ ¼å¼æ­£ç¡®

### 12.3 å®‰å…¨

- ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨PSK-TLSï¼ˆç«¯å£8445ï¼‰
- Flashå¯†é’¥åŒºåŸŸè®¾ç½®è¯»ä¿æŠ¤
- å›ºä»¶å‡çº§ä¸èƒ½è¦†ç›–å¯†é’¥

---
