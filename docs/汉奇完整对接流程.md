# 汉奇智能网关完整对接流程

## 流程概览

```
1. 网关MQTT连接 → 2. 网关注册 → 3. 心跳保活 → 4. 用户绑定网关
  → 5. 开始配对子设备 → 6. 上报子设备列表 → 7. 子设备数据上报
```

---

## 第一步：网关MQTT连接

### 连接信息

- **Broker地址**: `35.172.194.174`
- **TCP端口**: `1883`
- **PSK端口**: `8445` (TLS-PSK加密)
- **ClientID**: `gateway_{网关ID}`
- **认证方式**:
  - TCP端口: 用户名密码认证（需先调用PSK生成接口）
  - PSK端口: TLS-PSK认证

### 订阅Topic

连接成功后，网关需要订阅命令Topic：

```
hanqi/gateway/{gatewayId}/command
```

---

## 第二步：网关注册

网关连接成功后，需要立即上报注册消息。

### 上报Topic

```
hanqi/gateway/{gatewayId}/report
```

### 消息格式

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155000001_abc123",
  "deviceId": "gateway_HQ2026",
  "timestamp": 1738155000,
  "data": {
    "entityType": "gateway",
    "action": "gateway_register"
  }
}
```

### 字段说明

| 字段              | 类型   | 说明                                  |
| ----------------- | ------ | ------------------------------------- |
| `msgType`         | string | 固定为 `"operate_devices"`            |
| `msgId`           | string | 消息ID，格式：`{时间戳}_{随机字符串}` |
| `deviceId`        | string | 网关ID，必须和MQTT ClientID中的一致   |
| `timestamp`       | number | Unix时间戳（秒）                      |
| `data.entityType` | string | 固定为 `"gateway"`                    |
| `data.action`     | string | 固定为 `"gateway_register"`           |

### 后端处理

- 创建未绑定用户的网关记录
- 状态：在线 `is_connected: 1`
- 等待用户绑定

---

## 第三步：心跳保活

网关需要定期发送心跳消息，保持在线状态。

### 心跳频率

建议：**每30秒一次**

### 上报Topic

```
hanqi/gateway/{gatewayId}/report
```

### 消息格式

```json
{
  "msgType": "heartbeat",
  "msgId": "1738155030001_def456",
  "deviceId": "gateway_HQ2026",
  "timestamp": 1738155030,
  "data": {}
}
```

### 心跳响应

后端会返回心跳响应，告知网关是否已绑定用户。

**响应Topic:** `hanqi/gateway/{gatewayId}/command`

**响应消息:**

```json
{
  "msgType": "heartbeat_ack",
  "msgId": "1738155030002_server",
  "deviceId": "gateway_HQ2026",
  "timestamp": 1738155030,
  "data": {
    "status": 0,
    "userId": null
  }
}
```

**status 说明：**

- `0`: 未绑定用户
- `1`: 已绑定用户

**网关可根据 status 判断是否需要进入配网模式。**

---

## 第四步：用户绑定网关（App操作）

### 配网流程（App端）

1. 用户打开App，点击"添加网关"
2. App通过**蓝牙**连接网关
3. 通过蓝牙获取网关ID
4. 通过蓝牙配置WiFi（SSID + 密码）
5. 网关连接WiFi并连接MQTT Broker
6. 网关发送注册消息（第二步）
7. App轮询调用 `POST /api/gateway/{gatewayId}/verify` 检查网关是否在线
8. 确认在线后，App调用 `POST /api/gateway/bind` 绑定网关

### 绑定接口

**HTTP接口:** `POST /api/gateway/bind`

**请求体:**

```json
{
  "gatewayId": "gateway_HQ2026",
  "name": "客厅网关"
}
```

**响应:**

```json
{
  "code": 200,
  "msg": "绑定成功",
  "data": {
    "gatewayId": "gateway_HQ2026",
    "name": "客厅网关",
    "isOnline": true,
    "message": "Gateway binding successful"
  }
}
```

### 绑定后的心跳响应

绑定成功后，网关会收到状态更新的心跳响应：

```json
{
  "msgType": "heartbeat_ack",
  "msgId": "1738155060001_server",
  "deviceId": "gateway_HQ2026",
  "timestamp": 1738155060,
  "data": {
    "status": 1,
    "userId": "507f1f77bcf86cd799439012"
  }
}
```

**网关可根据 status=1 判断已成功绑定用户。**

---

## 第五步：开始配对子设备

用户在App上点击"添加子设备"后，触发配对流程。

### App调用接口

**HTTP接口:** `POST /api/gateway/{gatewayId}/pairing_start`

### 网关接收的命令

**Topic:** `hanqi/gateway/{gatewayId}/command`

**消息格式:**

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155100001_server",
  "deviceId": "gateway_HQ2026",
  "timestamp": 1738155100,
  "data": {
    "entityType": "gateway",
    "action": "start_pairing"
  }
}
```

### 网关需要做的

1. 进入子设备配对模式
2. 打开433接收器/蓝牙等
3. 监听子设备的配对信号
4. 记录发现的子设备信息
5. 配对成功后，上报子设备列表（第六步）

---

## 第六步：上报子设备列表（重点！）

配对完成后，网关需要向云端上报发现的子设备。

### 上报Topic

```
hanqi/gateway/{gatewayId}/report
```

### 消息格式

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155200001_gateway",
  "deviceId": "gateway_HQ2026",
  "timestamp": 1738155200,
  "data": {
    "entityType": "subDevice",
    "action": "subdevice_add",
    "subDevices": [
      {
        "subDeviceId": "timer_A1B2C3",
        "deviceType": 1,
        "capabilities": 0,
        "productId": 1001,
        "firmwareVersion": "1.0.5",
        "online": true,
        "private": "AES_KEY_12345678"
      },
      {
        "subDeviceId": "timer_D4E5F6",
        "deviceType": 1,
        "capabilities": 1,
        "productId": 1001,
        "firmwareVersion": "1.0.5",
        "online": true,
        "private": "AES_KEY_87654321"
      }
    ]
  }
}
```

### 字段说明

#### 通用字段

| 字段        | 类型   | 必填 | 说明                       |
| ----------- | ------ | ---- | -------------------------- |
| `msgType`   | string | 是   | 固定为 `"operate_devices"` |
| `msgId`     | string | 是   | 消息ID                     |
| `deviceId`  | string | 是   | 网关ID                     |
| `timestamp` | number | 是   | Unix时间戳（秒）           |

#### data 字段

| 字段         | 类型   | 必填 | 说明                     |
| ------------ | ------ | ---- | ------------------------ |
| `entityType` | string | 是   | 固定为 `"subDevice"`     |
| `action`     | string | 是   | 固定为 `"subdevice_add"` |
| `subDevices` | array  | 是   | 子设备列表（可包含多个） |

#### subDevices 数组中每个子设备

| 字段              | 类型    | 必填 | 说明                                             |
| ----------------- | ------- | ---- | ------------------------------------------------ |
| `subDeviceId`     | string  | 是   | **子设备唯一ID**，建议格式：`timer_{MAC后6位}`   |
| `deviceType`      | number  | 是   | 设备类型，水阀固定为 `1`                         |
| `capabilities`    | number  | 是   | **出水口数量编码**（见下方）                     |
| `productId`       | number  | 是   | 产品ID                                           |
| `firmwareVersion` | string  | 是   | 固件版本号                                       |
| `online`          | boolean | 是   | 是否在线                                         |
| `private`         | string  | 是   | **子设备私有数据**（加密密钥等，云端会原样保存） |

### capabilities 编码规则（重要！）

`capabilities` 低2位表示出水口数量：

| capabilities | 出水口数量 | 水阀类型     |
| ------------ | ---------- | ------------ |
| `0`          | 1路        | valve_single |
| `1`          | 2路        | valve_dual   |
| `2`          | 3路        | valve_triple |
| `3`          | 4路        | valve_quad   |

**计算公式：**

```
出水口数量 = (capabilities & 0x03) + 1
```

### 后端处理

- 验证网关是否存在且已绑定用户
- 检查每个 `subDeviceId` 是否已存在（去重）
- 根据 `deviceType` 和 `capabilities` 判断水阀类型
- 创建子设备记录，关联到网关和用户
- 返回日志：`批量添加子设备完成: X 个成功, Y 个跳过`

---

---

## 测试清单

### 网关侧需要实现

- [ ] MQTT连接（TCP 1883 或 PSK 8883）
- [ ] 注册消息上报
- [ ] 心跳消息上报（30秒一次）
- [ ] 订阅命令Topic并处理
- [ ] 接收"开始配对"命令，进入配对模式
- [ ] 发现子设备并上报列表
- [ ] 转发子设备DP点数据

### 云端已实现

- [x] MQTT Broker（Aedes）
- [x] PSK认证
- [x] 网关注册处理
- [x] 心跳处理和响应
- [x] 用户绑定网关接口
- [x] 下发"开始配对"命令
- [x] 接收子设备上报并创建记录
- [x] 子设备DP点数据处理

---

## 注意事项

### 1. subDeviceId 必须唯一

- 建议使用子设备MAC地址
- 格式：`timer_{唯一标识}`
- 一旦分配不要更改

### 2. capabilities 务必正确

- 决定了App显示几路水阀
- 计算公式：`(capabilities & 0x03) + 1`

### 3. private 字段很重要

- 存储子设备的加密密钥
- 云端原样保存，不解析
- 子设备重新配对时可从云端恢复

### 4. 心跳必须定时发送

- 建议30秒一次
- 超过1分钟无心跳会被标记为离线

### 5. ClientID 格式

- 必须是：`gateway_{网关ID}`
- 与消息中的 `deviceId` 保持一致

---

## 快速测试

### MQTT测试工具模拟网关

**1. 连接MQTT**

```
Host: 35.172.194.174
Port: 1883
ClientID: gateway_TEST001
Username: (从PSK接口获取)
Password: (从PSK接口获取)
```

**2. 订阅命令Topic**

```
hanqi/gateway/gateway_TEST001/command
```

**3. 发送注册消息**
Topic: `hanqi/gateway/gateway_TEST001/report`

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155000001_test",
  "deviceId": "gateway_TEST001",
  "timestamp": 1738155000,
  "data": {
    "entityType": "gateway",
    "action": "gateway_register"
  }
}
```

**4. 发送心跳**
Topic: `hanqi/gateway/gateway_TEST001/report`

```json
{
  "msgType": "heartbeat",
  "msgId": "1738155030001_test",
  "deviceId": "gateway_TEST001",
  "timestamp": 1738155030,
  "data": {}
}
```

**5. 上报子设备**
Topic: `hanqi/gateway/gateway_TEST001/report`

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155200001_test",
  "deviceId": "gateway_TEST001",
  "timestamp": 1738155200,
  "data": {
    "entityType": "subDevice",
    "action": "subdevice_add",
    "subDevices": [
      {
        "subDeviceId": "timer_TESTDEV01",
        "deviceType": 1,
        "capabilities": 0,
        "productId": 1001,
        "firmwareVersion": "1.0.0",
        "online": true,
        "private": "test_key_123"
      }
    ]
  }
}
```

---
