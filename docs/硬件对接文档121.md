# 汉奇网关MQTT对接文档

## 1. 项目已完成功能

目前项目完成了网关侧的核心功能：

**PSK认证**

- 生成PSK密钥对（identity + key）
- 烧录确认
- MQTT连接时PSK验证

**网关注册和上线**

- 网关首次连接自动注册
- 心跳上报（30秒间隔）
- 在线/离线状态自动检测

**配网流程**

- 网关接收WiFi配置
- WiFi连接后MQTT上线
- App轮询验证网关在线
- 用户绑定网关到账号

**网关管理**

- 查询网关状态
- 查询用户的网关列表
- 解绑网关

## 2. PSK烧录流程

**步骤1：生成PSK**

```
POST http://your-server.com/psk/generate
Content-Type: application/json

{
  "macAddress": "AA:BB:CC:DD:EE:FF"
}
```

返回：

```json
{
  "identity": "AA:BB:CC:DD:EE:FF",
  "key": "a1b2c3d4...128位十六进制字符串"
}
```

**步骤2：烧录到设备**

将identity和key写入设备Flash。

**步骤3：确认烧录**

```
POST http://your-server.com/psk/confirm
Content-Type: application/json

{
  "macAddress": "AA:BB:CC:DD:EE:FF"
}
```

确认后PSK才会生效，设备才能连接MQTT。

## 3. MQTT连接

**Broker地址**

- TCP连接端口：1885（普通连接，方便使用mqttx测试用）
- PSK连接端口：8445（TLS + PSK认证，推荐使用）
- 协议：MQTT over TLS
- 认证：PSK
- ClientID格式：`gateway_{网关ID}_{时间戳}`

例如：`gateway_HQ001_1705734000`

**连接后订阅**

订阅命令Topic：

```
hanqi/gateway/{网关ID}/command
```

## 4. Topic说明

| Topic                            | 方向      | 用途     |
| -------------------------------- | --------- | -------- |
| `hanqi/gateway/{网关ID}/report`  | 网关→云端 | 上报数据 |
| `hanqi/gateway/{网关ID}/command` | 云端→网关 | 下发命令 |

## 5. 消息格式

所有消息统一使用JSON格式：

```json
{
  "msgType": "消息类型",
  "msgId": "时间戳_随机串",
  "deviceId": "网关ID",
  "timestamp": 1705734000,
  "data": {
    "entityType": "gateway",
    ...
  }
}
```

### 目前支持的消息类型

| msgType           | 说明                     | 方向      |
| ----------------- | ------------------------ | --------- |
| `heartbeat`       | 心跳                     | 网关→云端 |
| `operate_devices` | 网关操作（注册、重启等） | 网关→云端 |
| `device_status`   | 网关状态上报             | 网关→云端 |

## 6. 网关上线流程

**1. 首次注册**

网关连接MQTT后发送注册消息：

```json
{
  "msgType": "operate_devices",
  "msgId": "1705734000_abc",
  "deviceId": "HQ001",
  "timestamp": 1705734000,
  "data": {
    "entityType": "gateway",
    "action": "gateway_register",
    "firmwareVersion": "1.0.0",
    "mac": "AA:BB:CC:DD:EE:FF"
  }
}
```

发送到Topic：`hanqi/gateway/HQ001/report`

云端收到后会创建网关记录（未绑定用户状态）。

**2. 心跳上报**

每30秒发送一次心跳：

```json
{
  "msgType": "heartbeat",
  "msgId": "1705734030_def",
  "deviceId": "HQ001",
  "timestamp": 1705734030,
  "data": {
    "entityType": "gateway"
  }
}
```

**3. 状态上报（可选）**

建议5分钟上报一次设备状态：

```json
{
  "msgType": "device_status",
  "msgId": "1705734300_ghi",
  "deviceId": "HQ001",
  "timestamp": 1705734300,
  "data": {
    "entityType": "gateway",
    "online": true,
    "wifi_rssi": -45,
    "firmware": "1.0.0",
    "memory_usage": 45,
    "cpu_usage": 30
  }
}
```

## 7. 配网流程

完整的配网流程如下：

1. **App蓝牙连接网关**
   - 用户打开App，扫描蓝牙设备
   - 连接到网关（广播名称建议：`HanqiGW-{网关ID}`）
   - 获取网关ID

2. **App发送WiFi信息**
   - 用户输入WiFi的SSID和密码
   - App通过蓝牙发送给网关
   - 网关接收配置信息

3. **网关连接WiFi**
   - 网关收到配置后连接WiFi
   - WiFi连接成功

4. **网关连接MQTT**
   - WiFi连接成功后，网关立即连接MQTT Broker
   - 使用PSK认证

5. **网关发送注册消息**
   - 连接成功后发送 `gateway_register` 消息
   - 云端创建网关记录

6. **App轮询验证在线**
   - App调用 `POST /gateway/{网关ID}/verify` 接口
   - 检查网关是否在线
   - 每隔2-3秒轮询一次

7. **App绑定网关**
   - 确认网关在线后
   - 用户输入网关名称
   - 调用 `POST /gateway/bind` 接口
   - 网关绑定到用户账号

**网关端需要实现：**

- 启动时开启BLE广播
- 提供BLE服务接收WiFi配置（SSID + 密码）
- 收到配置后连接WiFi
- WiFi连接成功后连接MQTT Broker
- 发送注册消息

## 8. 在线检测规则

**网关在线条件：**

- 数据库标志 `is_connected = 1`
- 且最后心跳时间 `last_seen` 在60秒内

**离线触发：**

- 超过60秒未收到心跳，自动标记离线
- MQTT连接断开，立即标记离线

## 9. 重要提醒

**网关必须实现：**

- 每30秒发送一次心跳
- 心跳不能间断，否则会被标记为离线
- 网络断开后需要自动重连
- ClientID格式必须正确：`gateway_{网关ID}_{时间戳}`

**消息格式要求：**

- 所有字段名严格区分大小写
- `timestamp` 是Unix时间戳（秒，不是毫秒）
- `msgId` 格式：`{timestamp}_{随机字符串}`
- `data.entityType` 必须是 `"gateway"`

**action字段（operate_devices消息）：**

- `gateway_register` - 网关注册
- `gateway_reboot` - 网关重启

## 10. API接口

App或测试时可用的HTTP接口：

**验证网关在线**

```
POST /gateway/{网关ID}/verify
Headers: Authorization: Bearer {JWT_TOKEN}
```

返回：

```json
{
  "gatewayId": "HQ001",
  "isOnline": true,
  "message": "The gateway has been launched."
}
```

**绑定网关**

```
POST /gateway/bind
Headers: Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "gatewayId": "HQ001",
  "name": "客厅网关"
}
```

**查询网关状态**

```
GET /gateway/{网关ID}/status
Headers: Authorization: Bearer {JWT_TOKEN}
```

返回：

```json
{
  "gatewayId": "HQ001",
  "name": "客厅网关",
  "isOnline": true,
  "lastSeen": "2025-01-20T10:30:00.000Z",
  "wifiRssi": -45,
  "firmwareVersion": "1.0.0"
}
```

**查询用户的网关列表**

```
GET /gateway/list
Headers: Authorization: Bearer {JWT_TOKEN}
```

**解绑网关**

```
DELETE /gateway/{网关ID}
Headers: Authorization: Bearer {JWT_TOKEN}
```
