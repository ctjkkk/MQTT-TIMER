# 汉奇智能网关完整对接流程

## 流程概览

```
1. 网关MQTT连接 → 2. 网关注册 → 3. 心跳保活 → 4. 用户绑定网关
  → 5. 开始配对子设备 → 6. 上报子设备列表 → 7. 自动关闭配对
  → 8. 子设备数据上报 → 9. 子设备状态上报
```

---

## 云端消息分发流程

固件端上报的MQTT消息通过以下流程进行路由和分发：

```
┌─────────────────────────────────────────────────────────────────┐
│  MQTT消息到达 (Topic: hanqi/gateway/{gatewayId}/report)         │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
              ┌──────────────────────────────┐
              │  解析消息体 JSON              │
              │  提取 data.entityType 字段    │
              └──────────┬───────────────────┘
                         ↓
        ┌────────────────┴────────────────┐
        ↓                                 ↓
┌───────────────────┐          ┌──────────────────────┐
│ entityType:       │          │ entityType:          │
│ "gateway"         │          │ "subDevice"          │
└────────┬──────────┘          └─────────┬────────────┘
         ↓                                ↓
┌─────────────────────┐         ┌─────────────────────┐
│ GatewayEventsHandler│         │ TimerEventsHandler  │
└────────┬────────────┘         └─────────┬───────────┘
         ↓                                 ↓
  【根据 msgType 分发】              【根据 msgType 分发】
         │                                 │
    ┌────┴─────┬────────┐         ┌───────┴────┬─────────────┬──────────────┐
    ↓          ↓        ↓         ↓            ↓             ↓              ↓
heartbeat  operate_  其他    dp_report  device_status  heartbeat  operate_devices
           devices                                                (action分发)
    ↓          ↓                    ↓            ↓             ↓              ↓
    │    【根据 action】              │            │             │         subdevice_add
    │          │                    │            │             │         subdevice_delete
    │    ┌─────┴──────┐             │            │             │         subdevice_update
    │    ↓            ↓             │            │             │
    │ start_    stop_pairing        │            │             │
    │ pairing   gateway_register    │            │             │
    ↓          ↓                    ↓            ↓             ↓              ↓
┌────────────────────────────────────────────────────────────────────────────┐
│                        GatewayService / TimerService                       │
│                         执行具体业务逻辑并更新数据库                         │
└────────────────────────────────────────────────────────────────────────────┘
```

**分发规则总结：**

1. **第一级路由**：根据 `data.entityType` 字段区分网关消息和子设备消息
   - `entityType: "gateway"` → GatewayEventsHandler
   - `entityType: "subDevice"` → TimerEventsHandler

2. **第二级路由**：根据 `msgType` 字段确定消息类型
   - `heartbeat` → 心跳处理
   - `operate_devices` → 设备操作（需进一步判断action）
   - `dp_report` → DP点数据上报
   - `device_status` → 设备状态上报

3. **第三级路由**（仅针对 `operate_devices`）：根据 `data.action` 字段确定具体操作
   - `gateway_register` → 网关注册
   - `start_pairing` → 开始配对
   - `stop_pairing` → 停止配对
   - `subdevice_add` → 添加子设备
   - `subdevice_delete` → 删除子设备
   - `subdevice_update` → 更新子设备

---

## 第一步：网关MQTT连接

### 连接信息

- **Broker地址**: `35.172.194.174`
- **TCP端口**: `1883`
- **PSK端口**: `8445` (TLS-PSK加密)
- **ClientID**: `gateway_{网关ID}`（注意：ClientID 包含 gateway\_ 前缀，但消息中的 deviceId 不包含）
- **认证方式**:
  - TCP端口: 用户名密码认证（需先调用PSK生成接口）
  - PSK端口: TLS-PSK认证

### 订阅Topic

连接成功后，网关需要订阅命令Topic：

```
hanqi/gateway/{gatewayId}/command
```

**示例**：网关ID为 `HQ2026`，则订阅 `hanqi/gateway/HQ2026/command`

---

## 第二步：网关注册

网关连接成功后，需要立即上报注册消息。

### 上报Topic

```
hanqi/gateway/{gatewayId}/report
```

### 消息格式

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155000001_abc123",
  "deviceId": "HQ2026",
  "timestamp": 1738155000,
  "data": {
    "entityType": "gateway",
    "action": "gateway_register"
  }
}
```

### 字段说明

| 字段              | 类型   | 说明                                  |
| ----------------- | ------ | ------------------------------------- |
| `msgType`         | string | 固定为 `"operate_devices"`            |
| `msgId`           | string | 消息ID，格式：`{时间戳}_{随机字符串}` |
| `deviceId`        | string | 网关ID（**不包含** `gateway_` 前缀）  |
| `timestamp`       | number | Unix时间戳（秒）                      |
| `data.entityType` | string | 固定为 `"gateway"`                    |
| `data.action`     | string | 固定为 `"gateway_register"`           |

### 后端处理

- 创建未绑定用户的网关记录
- 状态：在线 `is_connected: 1`
- 等待用户绑定

---

## 第三步：心跳保活

网关需要定期发送心跳消息，保持在线状态。

### 心跳频率

建议：**每30秒一次**

### 上报Topic

```
hanqi/gateway/{gatewayId}/report
```

### 消息格式

```json
{
  "msgType": "heartbeat",
  "msgId": "1738155030001_def456",
  "deviceId": "HQ2026",
  "timestamp": 1738155030,
  "data": {
    // 这里需要一些数据，例如网关的信号强度等，与涂鸦云保持一致即可
  }
}
```

### 心跳响应

后端会返回心跳响应，告知网关是否已绑定用户。

**响应Topic:** `hanqi/gateway/{gatewayId}/command`

**响应消息:**

```json
{
  "msgType": "heartbeat_ack",
  "msgId": "1738155030002_server",
  "deviceId": "HQ2026",
  "timestamp": 1738155030,
  "data": {
    "status": 0,
    "userId": null
  }
}
```

**status 说明：**

- `0`: 未绑定用户
- `1`: 已绑定用户

**网关可根据 status 判断是否需要进入配网模式。**

---

## 第四步：用户绑定网关（App操作）

### 配网流程（App端）

1. 用户打开App，点击"添加网关"
2. App通过**蓝牙**连接网关
3. 通过蓝牙获取网关ID
4. 通过蓝牙配置WiFi（SSID + 密码）
5. 网关连接WiFi并连接MQTT Broker
6. 网关发送注册消息（第二步）
7. App轮询调用 `POST /api/gateway/{gatewayId}/verify` 检查网关是否在线
8. 确认在线后，App调用 `POST /api/gateway/bind` 绑定网关

### 绑定接口

**HTTP接口:** `POST /api/gateway/bind`

**请求体:**

```json
{
  "gatewayId": "HQ2026",
  "name": "客厅网关"
}
```

**响应:**

```json
{
  "code": 200,
  "msg": "绑定成功",
  "data": {
    "gatewayId": "HQ2026",
    "name": "客厅网关",
    "isOnline": true,
    "message": "Gateway binding successful"
  }
}
```

### 绑定后的心跳响应

绑定成功后，网关会收到状态更新的心跳响应：

```json
{
  "msgType": "heartbeat_ack",
  "msgId": "1738155060001_server",
  "deviceId": "HQ2026",
  "timestamp": 1738155060,
  "data": {
    "status": 1,
    "userId": "507f1f77bcf86cd799439012"
  }
}
```

**网关可根据 status=1 判断已成功绑定用户。**

---

## 第五步：开始配对子设备

用户在App上点击"添加子设备"后，触发配对流程。

### App调用接口

**HTTP接口:** `POST /api/gateway/{gatewayId}/pairing_start`

### 网关接收的命令

**Topic:** `hanqi/gateway/{gatewayId}/command`

**消息格式:**

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155100001_server",
  "deviceId": "HQ2026",
  "timestamp": 1738155100,
  "data": {
    "entityType": "gateway",
    "action": "start_pairing",
    "timeout": 60 // 这里秒数我们商议决定；如果超时，网关可自行处理
  }
}
```

### 字段说明

| 字段           | 类型   | 必填 | 说明                         |
| -------------- | ------ | ---- | ---------------------------- |
| `data.action`  | string | 是   | 固定为 `"start_pairing"`     |
| `data.timeout` | number | 否   | 配对超时时间（秒），默认60秒 |

### 网关需要做的

1. 进入子设备配对模式
2. 打开433接收器/蓝牙等
3. 监听子设备的配对信号
4. 记录发现的子设备信息
5. 配对成功后，上报子设备列表（第六步）

---

## 第六步：上报子设备列表

配对完成后，网关需要向云端上报发现的子设备。

### 上报Topic

```
hanqi/gateway/{gatewayId}/report
```

### 消息格式

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155200001_gateway",
  "deviceId": "HQ2026",
  "timestamp": 1738155200,
  "data": {
    "entityType": "subDevice",
    "action": "subdevice_add",
    "subDevices": [
      //每个子设备上报的参数由你们来定，与涂鸦云保持一致即可
      {
        "uuid": "A1B2C3",
        "deviceType": 1,
        "capabilities": 0,
        "productId": 1001,
        "firmwareVersion": "1.0.5",
        "online": true
      },
      {
        "uuid": "timer_D4E5F6",
        "deviceType": 1,
        "capabilities": 1,
        "productId": 1001,
        "firmwareVersion": "1.0.5",
        "online": true
      }
    ]
  }
}
```

### 字段说明

#### 通用字段

| 字段        | 类型   | 必填 | 说明                       |
| ----------- | ------ | ---- | -------------------------- |
| `msgType`   | string | 是   | 固定为 `"operate_devices"` |
| `msgId`     | string | 是   | 消息ID                     |
| `deviceId`  | string | 是   | 网关ID                     |
| `timestamp` | number | 是   | Unix时间戳（秒）           |

#### data 字段

| 字段         | 类型   | 必填 | 说明                     |
| ------------ | ------ | ---- | ------------------------ |
| `entityType` | string | 是   | 固定为 `"subDevice"`     |
| `action`     | string | 是   | 固定为 `"subdevice_add"` |
| `subDevices` | array  | 是   | 子设备列表（可包含多个） |

#### subDevices 数组中每个子设备

| 字段              | 类型    | 必填 | 说明                         |
| ----------------- | ------- | ---- | ---------------------------- |
| `uuid`            | string  | 是   | **子设备唯一ID**，           |
| `deviceType`      | number  | 是   | 设备类型，水阀固定为 `1`     |
| `capabilities`    | number  | 是   | **出水口数量编码**（见下方） |
| `productId`       | number  | 是   | 产品ID                       |
| `firmwareVersion` | string  | 是   | 固件版本号                   |
| `online`          | boolean | 是   | 是否在线                     |

### capabilities 编码规则（重要！）

`capabilities` 低2位表示出水口数量：

| capabilities | 出水口数量 | 水阀类型     |
| ------------ | ---------- | ------------ |
| `0`          | 1路        | valve_single |
| `1`          | 2路        | valve_dual   |
| `2`          | 3路        | valve_triple |
| `3`          | 4路        | valve_quad   |

**计算公式：**

```
出水口数量 = (capabilities & 0x03) + 1
```

### 后端处理

- 验证网关是否存在且已绑定用户
- 检查每个 `uuid` 是否已存在
  - **已存在**：覆盖更新设备信息（网关ID、固件版本、能力值等）
  - **不存在**：创建新的子设备记录
- 根据 `deviceType` 和 `capabilities` 判断水阀类型
- 创建或更新子设备记录，关联到网关和用户
- **配对成功后，自动下发"停止配对"命令**（见第七步）
- 返回日志：`批量添加子设备完成: 新增 X 个, 更新 Y 个`

**使用场景：**
- 子设备首次配对 → 创建新记录
- 子设备重新配对（重置后） → 覆盖更新
- 子设备从A网关切换到B网关 → 更新网关ID

---

## 第七步：停止配对（新增）

### 触发场景

云端会在以下情况自动下发停止配对命令：

1. **配对成功**：收到子设备上报后，立即下发
2. **用户取消**：用户在App点击"取消添加"
3. **配对超时**：网关本地60秒超时（网关自己处理）

### 网关接收的命令

**Topic:** `hanqi/gateway/{gatewayId}/command`

**消息格式:**

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155260001_server",
  "deviceId": "HQ2026",
  "timestamp": 1738155260,
  "data": {
    "entityType": "gateway",
    "action": "stop_pairing",
    "reason": "success"
  }
}
```

### 字段说明

| 字段          | 类型   | 必填 | 说明                    |
| ------------- | ------ | ---- | ----------------------- |
| `data.action` | string | 是   | 固定为 `"stop_pairing"` |
| `data.reason` | string | 否   | 停止原因（见下表）      |

#### reason 枚举值

| 值            | 说明                             |
| ------------- | -------------------------------- |
| `success`     | 配对成功，自动结束               |
| `user_cancel` | 用户主动取消                     |
| `timeout`     | 配对超时（可选，网关可自行处理） |

### 网关需要做的

1. 退出配对模式
2. 关闭433接收器/蓝牙
3. 停止监听子设备信号
4. 返回正常工作模式

---

## 第八步：子设备状态上报（新增）

网关定期或实时上报子设备的在线状态、电池电量、信号强度。

### 上报场景

1. **状态变化时**：子设备上线/离线时立即上报
2. **定期批量上报**：每5分钟批量上报所有子设备状态

### 上报Topic

```
hanqi/gateway/{gatewayId}/report
```

### 消息格式

```json
{
  "msgType": "device_status",
  "msgId": "1738155400001_gateway",
  "deviceId": "HQ2026",
  "timestamp": 1738155400,
  "data": {
    "entityType": "subDevice",
    "subDevices": [
      {
        //必传字段，可根据后面功能的需求添加
        "uuid": "A1B2C3",
        "online": true
      },
      {
        "uuid": "D4E5F6",
        "online": false
      }
    ]
  }
}
```

### 字段说明

#### 通用字段

| 字段              | 类型   | 必填 | 说明                     |
| ----------------- | ------ | ---- | ------------------------ |
| `msgType`         | string | 是   | 固定为 `"device_status"` |
| `deviceId`        | string | 是   | 网关ID                   |
| `timestamp`       | number | 是   | Unix时间戳（秒）         |
| `data.entityType` | string | 是   | 固定为 `"subDevice"`     |
| `data.subDevices` | array  | 是   | 子设备状态数组           |

#### subDevices 数组元素

| 字段     | 类型    | 必填 | 说明         |
| -------- | ------- | ---- | ------------ |
| `uuid`   | string  | 是   | 子设备ID     |
| `online` | boolean | 是   | **是否在线** |

### 后端处理

- 只更新消息中包含的子设备
- 不在消息中的子设备保持原状态不变
- 更新数据库：`online`, `last_seen`
- 记录日志：`成功 X 个, 跳过 Y 个`

### 重要说明

**云端只处理消息中包含的子设备，不包含的子设备状态保持不变。**

**示例**：

- 数据库有10个子设备
- 消息中只包含2个子设备的状态
- 只更新这2个，其他8个保持原状态

---

## 完整配对流程示意图

```
用户点击"添加子设备"
  ↓
App调用 POST /api/gateway/{gatewayId}/pairing_start
  ↓
云端下发: start_pairing (timeout=60)
  Topic: hanqi/gateway/{gatewayId}/command
  ↓
网关进入配对模式
  - 打开433/915接收器/蓝牙
  - 监听子设备信号
  ↓
网关发现子设备并上报
  Topic: hanqi/gateway/{gatewayId}/report
  msgType: operate_devices
  action: subdevice_add
  ↓
云端创建子设备记录
  - 验证网关
  - 创建Timer记录
  ↓
云端自动下发: stop_pairing (reason='success')
  Topic: hanqi/gateway/{gatewayId}/command
  ↓
网关退出配对模式
  - 关闭接收器
  - 返回正常模式
```

---

## 测试清单

### 网关侧需要实现

- [ ] MQTT连接（TCP 1883 或 PSK 8445）
- [ ] 注册消息上报
- [ ] 心跳消息上报（30秒一次）
- [ ] 订阅命令Topic并处理
- [ ] 接收"开始配对"命令，进入配对模式
- [ ] 接收"停止配对"命令，退出配对模式 (新增)
- [ ] 发现子设备并上报列表
- [ ] 转发子设备DP点数据
- [ ] 上报子设备在线状态（实时或定期）(新增)

### 云端已实现

- [x] MQTT Broker（Aedes）
- [x] PSK认证
- [x] 网关注册处理
- [x] 心跳处理和响应
- [x] 用户绑定网关接口
- [x] 下发"开始配对"命令
- [x] 下发"停止配对"命令(新增)
- [x] 接收子设备上报并创建记录
- [x] 配对成功后自动关闭配对(新增)
- [x] 子设备状态批量更新(新增)

---

## 注意事项

### 1. deviceId 格式说明（重要！）

**ClientID** 和 **deviceId** 的区别：

| 场景                  | 格式               | 示例             |
| --------------------- | ------------------ | ---------------- |
| **MQTT ClientID**     | `gateway_{网关ID}` | `gateway_HQ2026` |
| **消息中的 deviceId** | `{网关ID}`         | `HQ2026`         |

**⚠️ 注意**：

- MQTT 连接时的 ClientID 需要 `gateway_` 前缀
- 但消息体中的 `deviceId` **不包含** `gateway_` 前缀
- 避免与 ClientID 混淆

### 2. flashId 必须唯一

- 格式：`{唯一标识}`
- 一旦分配不要更改

### 4. 心跳必须定时发送

- 建议30秒一次(可讨论决定)
- 超过1分钟无心跳会被标记为离线

### 5. 配对模式的退出

- 配对成功后，云端会自动下发 `stop_pairing` 命令
- 网关也应实现60秒超时自动退出
- 用户可通过App取消配对

### 6. 子设备状态上报

- 建议状态变化时立即上报（如上线/离线）
- 定期批量上报作为备份（如每5分钟）
- 云端只更新消息中包含的子设备

---

## 快速测试

### MQTT测试工具模拟网关

**1. 连接MQTT**

```
Host: 35.172.194.174
Port: 1883
ClientID: gateway_TEST001  ← 注意：ClientID 包含 gateway_ 前缀
Username: (从PSK接口获取)
Password: (从PSK接口获取)
```

**2. 订阅命令Topic**

```
hanqi/gateway/TEST001/command
```

**3. 发送注册消息**

Topic: `hanqi/gateway/TEST001/report`

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155000001_test",
  "deviceId": "TEST001",
  "timestamp": 1738155000,
  "data": {
    "entityType": "gateway",
    "action": "gateway_register"
  }
}
```

**4. 发送心跳**

Topic: `hanqi/gateway/TEST001/report`

```json
{
  "msgType": "heartbeat",
  "msgId": "1738155030001_test",
  "deviceId": "TEST001",
  "timestamp": 1738155030,
  "data": {}
}
```

**5. 上报子设备**

Topic: `hanqi/gateway/TEST001/report`

```json
{
  "msgType": "operate_devices",
  "msgId": "1738155200001_test",
  "deviceId": "TEST001",
  "timestamp": 1738155200,
  "data": {
    "entityType": "subDevice",
    "action": "subdevice_add",
    "subDevices": [
      {
        "flashId": "TESTDEV01",
        "deviceType": 1,
        "capabilities": 0,
        "productId": 1001,
        "firmwareVersion": "1.0.0",
        "online": true
      }
    ]
  }
}
```

**6. 上报子设备状态（新增）**

Topic: `hanqi/gateway/TEST001/report`

```json
{
  "msgType": "device_status",
  "msgId": "1738155300001_test",
  "deviceId": "TEST001",
  "timestamp": 1738155300,
  "data": {
    "entityType": "subDevice",
    "subDevices": [
      {
        "flashId": "TESTDEV01",
        "online": true
      }
    ]
  }
}
```

**预期**：云端自动下发 `stop_pairing` 命令到 `hanqi/gateway/TEST001/command`

---

## 附录：消息类型汇总

| 消息类型   | msgType           | 方向        | 说明                    |
| ---------- | ----------------- | ----------- | ----------------------- |
| 网关注册   | `operate_devices` | 网关 → 云端 | action=gateway_register |
| 心跳       | `heartbeat`       | 网关 → 云端 | 保活                    |
| 心跳响应   | `heartbeat_ack`   | 云端 → 网关 | 携带绑定状态            |
| 开始配对   | `operate_devices` | 云端 → 网关 | action=start_pairing    |
| 停止配对   | `operate_devices` | 云端 → 网关 | action=stop_pairing     |
| 子设备添加 | `operate_devices` | 网关 → 云端 | action=subdevice_add    |
| DP点上报   | `dp_report`       | 网关 → 云端 | 子设备数据              |
| DP点控制   | `dp_command`      | 云端 → 网关 | 控制子设备              |
| 子设备状态 | `device_status`   | 网关 → 云端 | 在线状态、电量、信号    |

---
