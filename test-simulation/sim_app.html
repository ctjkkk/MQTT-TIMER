<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ±‰å¥‡ç½‘å…³é…ç½‘æ¨¡æ‹Ÿå™¨</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 24px;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 14px;
      }

      .content {
        padding: 30px;
      }

      .step {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      .step.active {
        background: #e3f2fd;
        border-left-color: #2196f3;
      }

      .step.completed {
        background: #e8f5e9;
        border-left-color: #4caf50;
      }

      .step-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .step-number {
        width: 30px;
        height: 30px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
      }

      .step.completed .step-number {
        background: #4caf50;
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }

      .input-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .input-group input:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
      }

      button {
        width: 100%;
        padding: 14px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      button:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      button:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        font-size: 14px;
      }

      .status.info {
        background: #e3f2fd;
        color: #1976d2;
        border-left: 4px solid #2196f3;
      }

      .status.success {
        background: #e8f5e9;
        color: #388e3c;
        border-left: 4px solid #4caf50;
      }

      .status.error {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid #f44336;
      }

      .status.warning {
        background: #fff3e0;
        color: #f57c00;
        border-left: 4px solid #ff9800;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .device-list {
        list-style: none;
        margin-top: 15px;
      }

      .device-item {
        padding: 12px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .device-item:hover {
        border-color: #667eea;
        transform: translateX(5px);
      }

      .device-item.selected {
        border-color: #667eea;
        background: #f5f7ff;
      }

      .config-section {
        margin-top: 15px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
      }

      .log-container {
        margin-top: 20px;
        padding: 15px;
        background: #1e1e1e;
        color: #00ff00;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }

      .log-entry {
        margin-bottom: 5px;
      }

      .log-timestamp {
        color: #888;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸŒŸ æ±‰å¥‡ç½‘å…³é…ç½‘æ¨¡æ‹Ÿå™¨</h1>
        <p>æ— éœ€çœŸå®ç¡¬ä»¶ï¼Œå®Œæ•´æµ‹è¯•é…ç½‘æµç¨‹</p>
        <p style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 13px;">
          âš ï¸ <strong>ä¸šåŠ¡è§„åˆ™ï¼šä¸€ä¸ªç”¨æˆ·åªèƒ½ç»‘å®šä¸€ä¸ªç½‘å…³</strong><br>
          å¦‚éœ€æ›´æ¢ç½‘å…³ï¼Œè¯·å…ˆè§£ç»‘å½“å‰ç½‘å…³
        </p>
      </div>

      <div class="content">
        <!-- æ­¥éª¤1ï¼šè“ç‰™æ‰«æ -->
        <div class="step active" id="step1">
          <div class="step-title">
            <span class="step-number">1</span>
            <span>è“ç‰™æ‰«æç½‘å…³</span>
          </div>
          <button onclick="scanBluetooth()">å¼€å§‹æ‰«æè“ç‰™è®¾å¤‡</button>
          <ul class="device-list" id="deviceList"></ul>
        </div>

        <!-- æ­¥éª¤2ï¼šè¯»å–ç½‘å…³ID -->
        <div class="step" id="step2">
          <div class="step-title">
            <span class="step-number">2</span>
            <span>è¯»å–ç½‘å…³ID</span>
          </div>
          <div class="input-group">
            <label>ç½‘å…³IDï¼ˆMACåœ°å€ï¼‰</label>
            <input type="text" id="gatewayId" disabled placeholder="ç­‰å¾…è¯»å–..." />
          </div>
          <button onclick="readGatewayId()" id="btnReadId" disabled>è¯»å–ç½‘å…³ID</button>
        </div>

        <!-- æ­¥éª¤3ï¼šé…ç½®WiFi -->
        <div class="step" id="step3">
          <div class="step-title">
            <span class="step-number">3</span>
            <span>é…ç½®WiFi</span>
          </div>
          <div class="input-group">
            <label>WiFiåç§°ï¼ˆSSIDï¼‰</label>
            <input type="text" id="wifiSsid" placeholder="è¾“å…¥WiFiåç§°" disabled />
          </div>
          <div class="input-group">
            <label>WiFiå¯†ç </label>
            <input type="password" id="wifiPassword" placeholder="è¾“å…¥WiFiå¯†ç " disabled />
          </div>
          <button onclick="configureWiFi()" id="btnConfigWiFi" disabled>é…ç½®WiFi</button>
        </div>

        <!-- æ­¥éª¤4ï¼šæ£€æµ‹ä¸Šçº¿ -->
        <div class="step" id="step4">
          <div class="step-title">
            <span class="step-number">4</span>
            <span>ç­‰å¾…ç½‘å…³ä¸Šçº¿</span>
          </div>
          <button onclick="waitForOnline()" id="btnWaitOnline" disabled>å¼€å§‹æ£€æµ‹</button>
          <div id="onlineStatus"></div>
        </div>

        <!-- æ­¥éª¤5ï¼šç»‘å®šç½‘å…³ -->
        <div class="step" id="step5">
          <div class="step-title">
            <span class="step-number">5</span>
            <span>ç»‘å®šç½‘å…³</span>
          </div>
          <div class="config-section">
            <div class="input-group">
              <label>JWT Token</label>
              <input type="text" id="jwtToken" placeholder="ç²˜è´´JWT token" disabled />
            </div>
            <div class="input-group">
              <label>ç½‘å…³åç§°</label>
              <input type="text" id="gatewayName" placeholder="å®¢å…ç½‘å…³" disabled />
            </div>
          </div>
          <button onclick="bindGateway()" id="btnBind" disabled>ç»‘å®šç½‘å…³</button>
        </div>

        <!-- æ—¥å¿— -->
        <div class="log-container" id="logContainer">
          <div class="log-entry"><span class="log-timestamp">[ç³»ç»Ÿ]</span> æ¨¡æ‹Ÿå™¨å·²å°±ç»ª</div>
        </div>
      </div>
    </div>

    <script>
      // ========== é…ç½® ==========
      const API_BASE = 'http://localhost:8018/api'

      // çœŸå®Tokené…ç½®ï¼ˆå¯é€‰ï¼‰
      // å¦‚æœè®¾ç½®äº†REAL_TOKENï¼Œé¡µé¢åŠ è½½æ—¶ä¼šè‡ªåŠ¨å¡«å……
      const REAL_TOKEN =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4ZWM1Y2Q0Y2RlZWM3ZTNlOTI2YWUyNSIsImlhdCI6MTc2ODc5MjkyMCwiZXhwIjoxODAwMzI4OTIwfQ.7D0QOP21ffhC_j76kULCKaePqDetbpoMajF5_64U1Qw'
      // ç•™ç©ºåˆ™éœ€è¦æ‰‹åŠ¨è¾“å…¥token
      // const REAL_TOKEN = ''

      let currentGatewayId = ''
      let pollingInterval = null

      // ========== å·¥å…·å‡½æ•° ==========

      function log(message, type = 'info') {
        const container = document.getElementById('logContainer')
        const timestamp = new Date().toLocaleTimeString('zh-CN')
        const color =
          {
            info: '#00ff00',
            success: '#00ff00',
            error: '#ff0000',
            warning: '#ffaa00',
          }[type] || '#00ff00'

        const entry = document.createElement('div')
        entry.className = 'log-entry'
        entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span style="color:${color}">${message}</span>`
        container.appendChild(entry)
        container.scrollTop = container.scrollHeight
      }

      function showStatus(stepId, message, type) {
        const step = document.getElementById(stepId)
        let statusDiv = step.querySelector('.status')

        if (!statusDiv) {
          statusDiv = document.createElement('div')
          statusDiv.className = 'status'
          step.appendChild(statusDiv)
        }

        statusDiv.className = `status ${type}`
        statusDiv.textContent = message
      }

      function completeStep(stepNum) {
        document.getElementById(`step${stepNum}`).classList.add('completed')
        if (stepNum < 5) {
          document.getElementById(`step${stepNum + 1}`).classList.add('active')
        }
      }

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms))
      }

      // ========== æ­¥éª¤1ï¼šè“ç‰™æ‰«æ ==========

      async function scanBluetooth() {
        log('ğŸ” å¼€å§‹æ‰«æè“ç‰™è®¾å¤‡...')
        showStatus('step1', 'æ­£åœ¨æ‰«æ...', 'info')

        await sleep(2000) // æ¨¡æ‹Ÿæ‰«æå»¶è¿Ÿ

        // æ¨¡æ‹Ÿå‘ç°è®¾å¤‡ï¼ˆä¸€ä¸ªç”¨æˆ·åªèƒ½ç»‘å®šä¸€ä¸ªç½‘å…³ï¼Œæ‰€ä»¥åªæ˜¾ç¤ºå½“å‰è¦é…ç½‘çš„ç½‘å…³ï¼‰
        const devices = [
          { id: 'TEST_GATEWAY_001', name: 'HanQi_GW_001', rssi: -45 },
        ]

        const deviceList = document.getElementById('deviceList')
        deviceList.innerHTML = ''

        devices.forEach(device => {
          const li = document.createElement('li')
          li.className = 'device-item'
          li.innerHTML = `
                    <strong>${device.name}</strong><br>
                    <small>ID: ${device.id} | ä¿¡å·: ${device.rssi} dBm</small>
                `
          li.onclick = () => selectDevice(device.id, li)
          deviceList.appendChild(li)
        })

        log(`âœ… å‘ç°ç½‘å…³è®¾å¤‡ï¼š${devices[0].name}`)
        log(`ğŸ’¡ æç¤ºï¼šä¸€ä¸ªç”¨æˆ·åªèƒ½ç»‘å®šä¸€ä¸ªç½‘å…³`)
        showStatus('step1', 'å‘ç°è®¾å¤‡ï¼Œç‚¹å‡»é€‰æ‹©', 'success')
      }

      function selectDevice(deviceId, element) {
        // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.device-item').forEach(item => {
          item.classList.remove('selected')
        })

        element.classList.add('selected')
        currentGatewayId = deviceId

        log(`ğŸ“± å·²é€‰æ‹©è®¾å¤‡: ${deviceId}`)
        document.getElementById('btnReadId').disabled = false
        completeStep(1)
      }

      // ========== æ­¥éª¤2ï¼šè¯»å–ç½‘å…³ID ==========

      async function readGatewayId() {
        log('ğŸ“– æ­£åœ¨è¯»å–ç½‘å…³ID...')
        showStatus('step2', 'æ­£åœ¨é€šè¿‡è“ç‰™è¯»å–...', 'info')

        await sleep(1500) // æ¨¡æ‹Ÿè“ç‰™è¯»å–å»¶è¿Ÿ

        document.getElementById('gatewayId').value = currentGatewayId

        log(`âœ… ç½‘å…³ID: ${currentGatewayId}`)
        showStatus('step2', 'è¯»å–æˆåŠŸ', 'success')

        // å¯ç”¨WiFié…ç½®
        document.getElementById('wifiSsid').disabled = false
        document.getElementById('wifiPassword').disabled = false
        document.getElementById('btnConfigWiFi').disabled = false

        completeStep(2)
      }

      // ========== æ­¥éª¤3ï¼šé…ç½®WiFi ==========

      async function configureWiFi() {
        const ssid = document.getElementById('wifiSsid').value
        const password = document.getElementById('wifiPassword').value

        if (!ssid || !password) {
          showStatus('step3', 'è¯·è¾“å…¥WiFiä¿¡æ¯', 'error')
          return
        }

        log(`ğŸ“¡ æ­£åœ¨é…ç½®WiFi: ${ssid}`)
        showStatus('step3', 'æ­£åœ¨é€šè¿‡è“ç‰™å‘é€é…ç½®...', 'info')

        await sleep(2000) // æ¨¡æ‹Ÿé…ç½®å»¶è¿Ÿ

        log('âœ… WiFié…ç½®å·²å‘é€åˆ°ç½‘å…³')
        log('â³ ç½‘å…³æ­£åœ¨è¿æ¥WiFi...')
        log('â³ ç½‘å…³æ­£åœ¨è¿æ¥MQTT...')

        showStatus('step3', 'WiFié…ç½®æˆåŠŸï¼Œç½‘å…³æ­£åœ¨é‡æ–°è¿æ¥...', 'success')

        await sleep(3000) // æ¨¡æ‹Ÿç½‘å…³é‡è¿å»¶è¿Ÿ

        log('ğŸ’¡ æç¤º: ç°åœ¨éœ€è¦è¿è¡Œç½‘å…³æ¨¡æ‹Ÿè„šæœ¬')
        log('ğŸ’¡ æ‰§è¡Œ: node 2-simulate-gateway.js')

        showStatus('step3', 'é…ç½®å®Œæˆï¼è¯·è¿è¡Œç½‘å…³æ¨¡æ‹Ÿè„šæœ¬', 'warning')

        // å¯ç”¨åœ¨çº¿æ£€æµ‹
        document.getElementById('btnWaitOnline').disabled = false
        completeStep(3)
      }

      // ========== æ­¥éª¤4ï¼šç­‰å¾…ä¸Šçº¿ ==========

      async function waitForOnline() {
        log('ğŸ” å¼€å§‹è½®è¯¢æ£€æµ‹ç½‘å…³åœ¨çº¿çŠ¶æ€...')
        showStatus('step4', 'æ­£åœ¨æ£€æµ‹...', 'info')

        document.getElementById('btnWaitOnline').disabled = true

        let attempts = 0
        const maxAttempts = 30

        pollingInterval = setInterval(async () => {
          attempts++

          try {
            const response = await fetch(`${API_BASE}/gateway/${currentGatewayId}/verify`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
            })

            const data = await response.json()

            if (data.data && data.data.isOnline) {
              clearInterval(pollingInterval)
              log('âœ… ç½‘å…³å·²ä¸Šçº¿ï¼')
              showStatus('step4', 'ç½‘å…³å·²ä¸Šçº¿', 'success')

              // å¯ç”¨ç»‘å®š
              document.getElementById('jwtToken').disabled = false
              document.getElementById('gatewayName').disabled = false
              document.getElementById('btnBind').disabled = false

              completeStep(4)
              return
            }

            log(`â³ ç¬¬ ${attempts} æ¬¡æ£€æµ‹: ç½‘å…³ç¦»çº¿`)
            showStatus('step4', `æ£€æµ‹ä¸­... (${attempts}/${maxAttempts})`, 'info')
          } catch (error) {
            log(`âŒ æ£€æµ‹å¤±è´¥: ${error.message}`, 'error')
          }

          if (attempts >= maxAttempts) {
            clearInterval(pollingInterval)
            log('âŒ è¶…æ—¶: ç½‘å…³æœªä¸Šçº¿', 'error')
            showStatus('step4', 'è¶…æ—¶ï¼è¯·æ£€æŸ¥ç½‘å…³æ¨¡æ‹Ÿè„šæœ¬æ˜¯å¦è¿è¡Œ', 'error')
            document.getElementById('btnWaitOnline').disabled = false
          }
        }, 2000) // æ¯2ç§’æ£€æµ‹ä¸€æ¬¡
      }

      // ========== æ­¥éª¤5ï¼šç»‘å®šç½‘å…³ ==========

      async function bindGateway() {
        const token = document.getElementById('jwtToken').value
        const name = document.getElementById('gatewayName').value || 'æµ‹è¯•ç½‘å…³'

        if (!token) {
          showStatus('step5', 'è¯·è¾“å…¥JWT token', 'error')
          log('âŒ ç¼ºå°‘JWT token', 'error')
          return
        }

        log(`ğŸ”— æ­£åœ¨ç»‘å®šç½‘å…³: ${currentGatewayId}`)
        showStatus('step5', 'æ­£åœ¨ç»‘å®š...', 'info')

        try {
          const response = await fetch(`${API_BASE}/gateway/bind`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              gatewayId: currentGatewayId,
              name: name,
            }),
          })

          const data = await response.json()

          if (response.ok && data.code === 200) {
            log('ğŸ‰ ç½‘å…³ç»‘å®šæˆåŠŸï¼')
            log(`ğŸ“ ç½‘å…³åç§°: ${data.data.name}`)
            log(`ğŸ†” ç½‘å…³ID: ${data.data.gatewayId}`)
            log(`ğŸŸ¢ åœ¨çº¿çŠ¶æ€: ${data.data.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}`)

            showStatus('step5', 'ç»‘å®šæˆåŠŸï¼é…ç½‘æµç¨‹å®Œæˆ ğŸ‰', 'success')
            completeStep(5)
          } else {
            log(`âŒ ç»‘å®šå¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            showStatus('step5', `ç»‘å®šå¤±è´¥: ${data.message}`, 'error')
          }
        } catch (error) {
          log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error')
          showStatus('step5', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error')
        }
      }

      // ========== åˆå§‹åŒ– ==========

      window.onload = function () {
        log('âœ… å‰ç«¯æ¨¡æ‹Ÿå™¨å·²å°±ç»ª')

        // è‡ªåŠ¨å¡«å……çœŸå®Tokenï¼ˆå¦‚æœé…ç½®äº†ï¼‰
        if (REAL_TOKEN) {
          const tokenInput = document.getElementById('jwtToken')
          tokenInput.value = REAL_TOKEN
          log('ğŸ”‘ å·²è‡ªåŠ¨å¡«å……çœŸå®ç”¨æˆ·Token (qumeng039@126.com)', 'success')
          log('   Token: ' + REAL_TOKEN.substring(0, 50) + '...', 'info')
        }

        log('ğŸ“Œ è¯·æŒ‰æ­¥éª¤æ“ä½œï¼š')
        log('   1. ç‚¹å‡»"å¼€å§‹æ‰«æè“ç‰™è®¾å¤‡"')
        log('   2. é€‰æ‹©ä¸€ä¸ªç½‘å…³')
        log('   3. æŒ‰æ­¥éª¤å®Œæˆé…ç½‘')
      }

      // æ¸…ç†
      window.onbeforeunload = function () {
        if (pollingInterval) {
          clearInterval(pollingInterval)
        }
      }
    </script>
  </body>
</html>
