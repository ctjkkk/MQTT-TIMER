<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ±‰å¥‡ç½‘å…³é…ç½‘æ¨¡æ‹Ÿå™¨</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 24px;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 14px;
      }

      .content {
        padding: 30px;
      }

      .step {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      .step.active {
        background: #e3f2fd;
        border-left-color: #2196f3;
      }

      .step.completed {
        background: #e8f5e9;
        border-left-color: #4caf50;
      }

      .step-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .step-number {
        width: 30px;
        height: 30px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
      }

      .step.completed .step-number {
        background: #4caf50;
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }

      .input-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .input-group input:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
      }

      button {
        width: 100%;
        padding: 14px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      button:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      button:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        font-size: 14px;
      }

      .status.info {
        background: #e3f2fd;
        color: #1976d2;
        border-left: 4px solid #2196f3;
      }

      .status.success {
        background: #e8f5e9;
        color: #388e3c;
        border-left: 4px solid #4caf50;
      }

      .status.error {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid #f44336;
      }

      .status.warning {
        background: #fff3e0;
        color: #f57c00;
        border-left: 4px solid #ff9800;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .device-list {
        list-style: none;
        margin-top: 15px;
      }

      .device-item {
        padding: 12px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .device-item:hover {
        border-color: #667eea;
        transform: translateX(5px);
      }

      .device-item.selected {
        border-color: #667eea;
        background: #f5f7ff;
      }

      .config-section {
        margin-top: 15px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
      }

      .log-container {
        margin-top: 20px;
        padding: 15px;
        background: #1e1e1e;
        color: #00ff00;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }

      .log-entry {
        margin-bottom: 5px;
      }

      .log-timestamp {
        color: #888;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸŒŸ æ±‰å¥‡ç½‘å…³é…ç½‘æ¨¡æ‹Ÿå™¨</h1>
        <p>æ— éœ€çœŸå®ç¡¬ä»¶ï¼Œå®Œæ•´æµ‹è¯•é…ç½‘æµç¨‹</p>
        <p style="margin-top: 15px; padding: 10px; background: rgba(255, 255, 255, 0.2); border-radius: 8px; font-size: 13px">
          âš ï¸ <strong>ä¸šåŠ¡è§„åˆ™ï¼šä¸€ä¸ªç”¨æˆ·åªèƒ½ç»‘å®šä¸€ä¸ªç½‘å…³</strong><br />
          ğŸ’¡ ç½‘å…³ç»‘å®šåä¼šè‡ªåŠ¨å­˜å‚¨WiFiä¿¡æ¯å¹¶è‡ªåŠ¨ä¸Šçº¿<br />
          ğŸ’¡ å·²ç»‘å®šçš„ç½‘å…³ä¼šè¢«è‡ªåŠ¨è¯†åˆ«ï¼Œæ— éœ€é‡å¤é…ç½‘
        </p>
      </div>

      <div class="content">
        <!-- æ­¥éª¤1ï¼šè“ç‰™æ‰«æ -->
        <div class="step active" id="step1">
          <div class="step-title">
            <span class="step-number">1</span>
            <span>è“ç‰™æ‰«æç½‘å…³</span>
          </div>
          <button type="button" onclick="scanBluetooth()">å¼€å§‹æ‰«æè“ç‰™è®¾å¤‡</button>
          <ul class="device-list" id="deviceList"></ul>
        </div>

        <!-- æ­¥éª¤2ï¼šè¯»å–ç½‘å…³ID -->
        <div class="step" id="step2">
          <div class="step-title">
            <span class="step-number">2</span>
            <span>è¯»å–ç½‘å…³ID</span>
          </div>
          <div class="input-group">
            <label>ç½‘å…³IDï¼ˆMACåœ°å€ï¼‰</label>
            <input type="text" id="gatewayId" disabled placeholder="ç­‰å¾…è¯»å–..." />
          </div>
          <div class="input-group">
            <label>JWT Tokenï¼ˆç”¨äºéªŒè¯ç½‘å…³ç»‘å®šçŠ¶æ€ï¼‰</label>
            <input type="text" id="jwtTokenEarly" placeholder="ç²˜è´´JWT tokenï¼ˆå¯é€‰ï¼‰" />
            <small style="color: #666; margin-top: 5px; display: block">ğŸ’¡ æå‰è¾“å…¥Tokenå¯æ£€æŸ¥ç½‘å…³æ˜¯å¦å·²ç»‘å®šï¼Œé¿å…é‡å¤é…ç½‘</small>
          </div>
          <button type="button" onclick="readGatewayId()" id="btnReadId" disabled>è¯»å–ç½‘å…³ID</button>
        </div>

        <!-- æ­¥éª¤3ï¼šé…ç½®WiFi -->
        <div class="step" id="step3">
          <div class="step-title">
            <span class="step-number">3</span>
            <span>é…ç½®WiFi</span>
          </div>
          <div class="status info" style="margin-bottom: 15px">
            ğŸ’¡ <strong>æ™ºèƒ½åˆ¤æ–­</strong>ï¼šå¦‚æœç½‘å…³å·²ç»‘å®šç”¨æˆ·ï¼Œå°†è‡ªåŠ¨è·³è¿‡æ­¤æ­¥éª¤ï¼ˆç½‘å…³ä¼šè‡ªåŠ¨ä¸Šçº¿ï¼‰
          </div>
          <div class="input-group">
            <label>WiFiåç§°ï¼ˆSSIDï¼‰</label>
            <input type="text" id="wifiSsid" placeholder="è¾“å…¥WiFiåç§°" disabled />
          </div>
          <div class="input-group">
            <label>WiFiå¯†ç </label>
            <input type="password" id="wifiPassword" placeholder="è¾“å…¥WiFiå¯†ç " disabled />
          </div>
          <button type="button" onclick="configureWiFi()" id="btnConfigWiFi" disabled>é…ç½®WiFi</button>
        </div>

        <!-- æ­¥éª¤4ï¼šæ£€æµ‹ä¸Šçº¿ -->
        <div class="step" id="step4">
          <div class="step-title">
            <span class="step-number">4</span>
            <span>ç­‰å¾…ç½‘å…³ä¸Šçº¿</span>
          </div>
          <div class="status info" style="margin-bottom: 15px">
            ğŸ’¡ <strong>æ™ºèƒ½æç¤º</strong>ï¼šå¦‚æ­¥éª¤2å·²æ£€æµ‹åˆ°ç½‘å…³å·²ç»‘å®šï¼Œæ­¤æ­¥éª¤å°†è‡ªåŠ¨å®Œæˆ
          </div>
          <div class="config-section">
            <div class="input-group">
              <label>JWT Tokenï¼ˆç”¨äºéªŒè¯ç½‘å…³çŠ¶æ€ï¼‰</label>
              <input type="text" id="jwtToken" placeholder="ç²˜è´´JWT token" disabled />
              <small style="color: #666; margin-top: 5px; display: block">ğŸ’¡ Tokenå·²åœ¨æ­¥éª¤2è¾“å…¥ï¼Œæˆ–åœ¨æ­¥éª¤3å®Œæˆåå¯ç”¨</small>
            </div>
          </div>
          <button type="button" onclick="waitForOnline()" id="btnWaitOnline" disabled>å¼€å§‹æ£€æµ‹</button>
          <div id="onlineStatus"></div>
        </div>

        <!-- æ­¥éª¤5ï¼šç»‘å®šç½‘å…³ -->
        <div class="step" id="step5">
          <div class="step-title">
            <span class="step-number">5</span>
            <span>ç»‘å®šç½‘å…³åˆ°ç”¨æˆ·</span>
          </div>
          <div class="status warning" style="margin-bottom: 15px">
            âš ï¸ <strong>ä¸šåŠ¡è§„åˆ™</strong>ï¼šä¸€ä¸ªç”¨æˆ·åªèƒ½ç»‘å®šä¸€ä¸ªç½‘å…³ï¼Œç½‘å…³ç»‘å®šåä¼šè‡ªåŠ¨é€šè¿‡å·²å­˜å‚¨çš„WiFiä¿¡æ¯ä¸Šçº¿
          </div>
          <div class="config-section">
            <div class="input-group">
              <label>ç½‘å…³åç§°</label>
              <input type="text" id="gatewayName" placeholder="ä¾‹å¦‚ï¼šå®¢å…ç½‘å…³" disabled />
              <small style="color: #666; margin-top: 5px; display: block">ğŸ’¡ Tokenå·²åœ¨æ­¥éª¤2è¾“å…¥</small>
            </div>
          </div>
          <button type="button" onclick="bindGateway()" id="btnBind" disabled>ç»‘å®šç½‘å…³</button>
        </div>

        <!-- ğŸ†• æ­¥éª¤6ï¼šæ·»åŠ å­è®¾å¤‡ -->
        <div class="step" id="step6">
          <div class="step-title">
            <span class="step-number">6</span>
            <span>æ·»åŠ å­è®¾å¤‡ï¼ˆæ°´é˜€ï¼‰</span>
          </div>
          <div class="status info" style="margin-bottom: 15px">
            ğŸ’¡ <strong>å‰ç½®æ¡ä»¶</strong>ï¼šç½‘å…³å¿…é¡»å·²ç»‘å®šç”¨æˆ·ä¸”åœ¨çº¿
          </div>
          <button type="button" onclick="startPairing()" id="btnStartPairing" disabled>å¼€å§‹é…å¯¹å­è®¾å¤‡</button>
          <button type="button" onclick="stopPairing()" id="btnStopPairing" disabled style="margin-top: 10px">åœæ­¢é…å¯¹</button>
          <div id="pairingStatus"></div>
          <div id="subDeviceList" style="margin-top: 15px"></div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="log-container" id="logContainer">
          <div class="log-entry"><span class="log-timestamp">[ç³»ç»Ÿ]</span> æ¨¡æ‹Ÿå™¨å·²å°±ç»ª</div>
        </div>
      </div>
    </div>

    <script>
      // ========== å…¨å±€é”™è¯¯æ•è· ==========
      window.addEventListener('error', function (event) {
        console.error('å…¨å±€é”™è¯¯æ•è·:', event.error)
        log(`âŒ æ•è·åˆ°é”™è¯¯: ${event.error?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
        event.preventDefault() // é˜»æ­¢é»˜è®¤é”™è¯¯å¤„ç†ï¼ˆé˜²æ­¢é¡µé¢é‡è½½ï¼‰
      })

      window.addEventListener('unhandledrejection', function (event) {
        console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason)
        log(`âŒ Promiseé”™è¯¯: ${event.reason?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
        event.preventDefault() // é˜»æ­¢é»˜è®¤é”™è¯¯å¤„ç†ï¼ˆé˜²æ­¢é¡µé¢é‡è½½ï¼‰
      })

      // ========== é…ç½® ==========
      const API_BASE = 'http://localhost:8018/api'

      // çœŸå®Tokené…ç½®ï¼ˆå¯é€‰ï¼‰
      // å¦‚æœè®¾ç½®äº†REAL_TOKENï¼Œé¡µé¢åŠ è½½æ—¶ä¼šè‡ªåŠ¨å¡«å……
      const REAL_TOKEN =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4ZWM1Y2Q0Y2RlZWM3ZTNlOTI2YWUyNSIsImlhdCI6MTc2ODc5MjkyMCwiZXhwIjoxODAwMzI4OTIwfQ.7D0QOP21ffhC_j76kULCKaePqDetbpoMajF5_64U1Qw'
      // ç•™ç©ºåˆ™éœ€è¦æ‰‹åŠ¨è¾“å…¥token
      // const REAL_TOKEN = ''

      let currentGatewayId = ''
      let pollingInterval = null
      let pairingPollingInterval = null // ğŸ†• é…å¯¹è½®è¯¢å®šæ—¶å™¨

      // ========== å·¥å…·å‡½æ•° ==========

      function log(message, type = 'info') {
        try {
          const container = document.getElementById('logContainer')
          if (!container) {
            console.log(`[LOG] ${message}`)
            return
          }

          const timestamp = new Date().toLocaleTimeString('zh-CN')
          const color =
            {
              info: '#00ff00',
              success: '#00ff00',
              error: '#ff0000',
              warning: '#ffaa00',
            }[type] || '#00ff00'

          const entry = document.createElement('div')
          entry.className = 'log-entry'
          entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span style="color:${color}">${message}</span>`
          container.appendChild(entry)
          container.scrollTop = container.scrollHeight
        } catch (err) {
          console.error('Logå‡½æ•°é”™è¯¯:', err)
          console.log(`[LOG] ${message}`)
        }
      }

      function showStatus(stepId, message, type) {
        try {
          const step = document.getElementById(stepId)
          if (!step) {
            console.log(`[STATUS] ${stepId}: ${message}`)
            return
          }

          let statusDiv = step.querySelector('.status')

          if (!statusDiv) {
            statusDiv = document.createElement('div')
            statusDiv.className = 'status'
            step.appendChild(statusDiv)
          }

          statusDiv.className = `status ${type}`
          statusDiv.textContent = message
        } catch (err) {
          console.error('showStatusé”™è¯¯:', err)
          console.log(`[STATUS] ${stepId}: ${message}`)
        }
      }

      function completeStep(stepNum) {
        try {
          const currentStep = document.getElementById(`step${stepNum}`)
          if (currentStep) {
            currentStep.classList.add('completed')
          }

          if (stepNum < 5) {
            const nextStep = document.getElementById(`step${stepNum + 1}`)
            if (nextStep) {
              nextStep.classList.add('active')
            }
          }
        } catch (err) {
          console.error('completeStepé”™è¯¯:', err)
        }
      }

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms))
      }

      // ========== æ­¥éª¤1ï¼šè“ç‰™æ‰«æ ==========

      async function scanBluetooth() {
        log('ğŸ” å¼€å§‹æ‰«æè“ç‰™è®¾å¤‡...')
        showStatus('step1', 'æ­£åœ¨æ‰«æ...', 'info')

        const deviceList = document.getElementById('deviceList')
        deviceList.innerHTML = ''

        try {
          // çœŸå®æ‰«æï¼šè°ƒç”¨ç½‘å…³æ¨¡æ‹Ÿå™¨çš„BLEæœåŠ¡
          const response = await fetch('http://localhost:3002/bluetooth/info').catch(err => {
            throw new Error('æ— æ³•è¿æ¥åˆ°ç½‘å…³æ¨¡æ‹Ÿå™¨ï¼ˆç«¯å£3002ï¼‰')
          })

          if (!response) {
            throw new Error('ç½‘å…³æ¨¡æ‹Ÿå™¨æœªå“åº”')
          }

          if (!response.ok) {
            throw new Error('ç½‘å…³æ¨¡æ‹Ÿå™¨è¿”å›é”™è¯¯çŠ¶æ€: ' + response.status)
          }

          let gateway
          try {
            gateway = await response.json()
          } catch (jsonErr) {
            throw new Error('ç½‘å…³è¿”å›æ•°æ®æ ¼å¼é”™è¯¯')
          }

          if (!gateway || !gateway.id) {
            throw new Error('ç½‘å…³æ•°æ®ä¸å®Œæ•´')
          }

          const li = document.createElement('li')
          li.className = 'device-item'
          li.innerHTML = `
            <strong>${gateway.name || 'æœªçŸ¥ç½‘å…³'}</strong><br>
            <small>ID: ${gateway.id} | ä¿¡å·: ${gateway.rssi || '?'} dBm</small>
          `
          li.onclick = () => selectDevice(gateway.id, li)
          deviceList.appendChild(li)

          log(`âœ… å‘ç°ç½‘å…³è®¾å¤‡ï¼š${gateway.name}`)
          log(`ğŸ’¡ æç¤ºï¼šä¸€ä¸ªç”¨æˆ·åªèƒ½ç»‘å®šä¸€ä¸ªç½‘å…³`)
          showStatus('step1', 'å‘ç°è®¾å¤‡ï¼Œç‚¹å‡»é€‰æ‹©', 'success')
        } catch (error) {
          console.error('è“ç‰™æ‰«æé”™è¯¯:', error)
          log(`âŒ æ‰«æå¤±è´¥: ${error.message}`, 'error')
          log('ğŸ’¡ è¯·å…ˆå¯åŠ¨ç½‘å…³æ¨¡æ‹Ÿå™¨: cd test && npm start', 'warning')
          showStatus('step1', 'æ‰«æå¤±è´¥ï¼Œè¯·å…ˆå¯åŠ¨ç½‘å…³æ¨¡æ‹Ÿå™¨', 'error')
        }
      }

      function selectDevice(deviceId, element) {
        try {
          // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
          document.querySelectorAll('.device-item').forEach(item => {
            item.classList.remove('selected')
          })

          if (element) {
            element.classList.add('selected')
          }

          currentGatewayId = deviceId

          log(`ğŸ“± å·²é€‰æ‹©è®¾å¤‡: ${deviceId}`)

          const btnReadId = document.getElementById('btnReadId')
          if (btnReadId) {
            btnReadId.disabled = false
          }

          completeStep(1)
        } catch (err) {
          console.error('selectDeviceé”™è¯¯:', err)
          log(`âŒ é€‰æ‹©è®¾å¤‡å¤±è´¥: ${err.message}`, 'error')
        }
      }

      // ========== æ­¥éª¤2ï¼šè¯»å–ç½‘å…³ID ==========

      async function readGatewayId() {
        log('ğŸ“– æ­£åœ¨è¯»å–ç½‘å…³ID...')
        showStatus('step2', 'æ­£åœ¨é€šè¿‡è“ç‰™è¯»å–...', 'info')

        await sleep(1500) // æ¨¡æ‹Ÿè“ç‰™è¯»å–å»¶è¿Ÿ

        document.getElementById('gatewayId').value = currentGatewayId

        log(`âœ… ç½‘å…³ID: ${currentGatewayId}`)
        showStatus('step2', 'è¯»å–æˆåŠŸ', 'success')
        completeStep(2)

        // ğŸ†• æ™ºèƒ½åˆ¤æ–­ï¼šæ£€æŸ¥ç½‘å…³æ˜¯å¦å·²åœ¨çº¿
        log('ğŸ” æ£€æŸ¥ç½‘å…³æ˜¯å¦å·²é…ç½‘å¹¶åœ¨çº¿...')
        await checkGatewayOnlineStatus()
      }

      /**
       * ğŸ†• æ£€æŸ¥ç½‘å…³ç»‘å®šçŠ¶æ€ï¼ˆæ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦é…ç½‘ï¼‰
       */
      async function checkGatewayOnlineStatus() {
        // ä¼˜å…ˆä»æ­¥éª¤2çš„tokenè¾“å…¥æ¡†è¯»å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»æ­¥éª¤4è¯»å–
        let token = document.getElementById('jwtTokenEarly').value
        if (!token) {
          token = document.getElementById('jwtToken').value
        }

        // åŒæ­¥ä¸¤ä¸ªtokenè¾“å…¥æ¡†
        if (token) {
          document.getElementById('jwtToken').value = token
          document.getElementById('jwtTokenEarly').value = token
        }

        if (!token) {
          log('âš ï¸  æœªè¾“å…¥Tokenï¼Œæ— æ³•æ£€æŸ¥ç½‘å…³ç»‘å®šçŠ¶æ€', 'warning')
          log('ğŸ’¡ é»˜è®¤è¿›å…¥é…ç½‘æµç¨‹ï¼ˆæ­¥éª¤3ï¼‰', 'info')
          // å¯ç”¨WiFié…ç½®
          enableWiFiConfig()
          return
        }

        try {
          // è°ƒç”¨ verify æ¥å£æ£€æŸ¥ç½‘å…³æ˜¯å¦å·²ç»‘å®šï¼ˆæ— éœ€æƒé™ï¼‰
          log('ğŸ” æ­£åœ¨æ£€æŸ¥ç½‘å…³ç»‘å®šçŠ¶æ€...')
          const response = await fetch(`${API_BASE}/gateway/${currentGatewayId}/verify`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              authorization: `Bearer ${token}`,
            },
          })

          const data = await response.json()

          if (response.ok && data.code === 200 && data.data) {
            const { exists, isOnline, isBound, userId, name } = data.data

            if (!exists) {
              // ç½‘å…³ä¸å­˜åœ¨ â†’ éœ€è¦é…ç½‘
              log('ğŸ“¡ ç½‘å…³æœªæ³¨å†Œï¼Œéœ€è¦é…ç½®WiFi', 'info')
              enableWiFiConfig()
              return
            }

            if (isBound && userId) {
              // ç½‘å…³å·²ç»‘å®š â†’ æ— éœ€ä»»ä½•æ“ä½œ
              log('âœ… æ£€æµ‹åˆ°ç½‘å…³å·²ç»‘å®šç”¨æˆ·ï¼', 'success')
              log(`ğŸ“ ç½‘å…³åç§°: ${name || 'æœªå‘½å'}`, 'info')
              log(`ğŸ‘¤ ç»‘å®šç”¨æˆ·ID: ${userId}`, 'info')
              log(`ğŸŒ åœ¨çº¿çŠ¶æ€: ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}`, 'info')
              log('ğŸ’¡ ç½‘å…³å·²å®Œæˆé…ç½‘å’Œç»‘å®šï¼Œæ— éœ€é‡å¤æ“ä½œ', 'success')
              log('ğŸ’¡ ç½‘å…³ä¼šè‡ªåŠ¨é€šè¿‡å·²å­˜å‚¨çš„WiFiä¿¡æ¯ä¸Šçº¿', 'info')

              // æ ‡è®°æ‰€æœ‰æ­¥éª¤ä¸ºå·²å®Œæˆ
              showStatus('step3', 'âœ… ç½‘å…³å·²ç»‘å®šï¼Œæ— éœ€é…ç½‘', 'success')
              document.getElementById('step3').classList.add('completed')

              showStatus('step4', 'âœ… ç½‘å…³å·²ç»‘å®šï¼Œè‡ªåŠ¨ä¸Šçº¿', 'success')
              document.getElementById('step4').classList.add('completed')

              showStatus('step5', 'âœ… ç½‘å…³å·²ç»‘å®šåˆ°ç”¨æˆ·', 'success')
              document.getElementById('step5').classList.add('completed')
              completeStep(5)

              // ç¦ç”¨æ‰€æœ‰åç»­æ“ä½œ
              document.getElementById('wifiSsid').disabled = true
              document.getElementById('wifiPassword').disabled = true
              document.getElementById('btnConfigWiFi').disabled = true
              document.getElementById('jwtToken').disabled = true
              document.getElementById('btnWaitOnline').disabled = true
              document.getElementById('gatewayName').disabled = true
              document.getElementById('btnBind').disabled = true

              // ğŸ†• å¯ç”¨æ­¥éª¤6ï¼ˆæ·»åŠ å­è®¾å¤‡ï¼‰- ç½‘å…³å·²ç»‘å®šä¸”åœ¨çº¿å¯ä»¥ç«‹å³æ·»åŠ å­è®¾å¤‡
              if (isOnline) {
                document.getElementById('btnStartPairing').disabled = false
                document.getElementById('step6').classList.add('active')
                log('âœ… ç½‘å…³åœ¨çº¿ï¼Œå¯ä»¥æ·»åŠ å­è®¾å¤‡ï¼ˆæ­¥éª¤6ï¼‰', 'success')
              } else {
                log('âš ï¸  ç½‘å…³ç¦»çº¿ï¼Œè¯·ç­‰å¾…ç½‘å…³ä¸Šçº¿åå†æ·»åŠ å­è®¾å¤‡', 'warning')
              }
            } else {
              // ç½‘å…³æœªç»‘å®š â†’ éœ€è¦é…ç½‘
              log('ğŸ“¡ ç½‘å…³å·²æ³¨å†Œä½†æœªç»‘å®šç”¨æˆ·ï¼Œéœ€è¦é…ç½®WiFi', 'info')
              enableWiFiConfig()
            }
          } else {
            // æŸ¥è¯¢å¤±è´¥ â†’ é»˜è®¤è¿›å…¥é…ç½‘æµç¨‹
            log('âš ï¸  æŸ¥è¯¢ç½‘å…³çŠ¶æ€å¤±è´¥ï¼Œé»˜è®¤è¿›å…¥é…ç½‘æµç¨‹', 'warning')
            enableWiFiConfig()
          }
        } catch (error) {
          console.error('æ£€æŸ¥ç½‘å…³ç»‘å®šçŠ¶æ€é”™è¯¯:', error)
          log('âš ï¸  æ— æ³•éªŒè¯ç½‘å…³ç»‘å®šçŠ¶æ€ï¼Œé»˜è®¤è¿›å…¥é…ç½‘æµç¨‹', 'warning')
          // å‡ºé”™æ—¶é»˜è®¤è¿›å…¥é…ç½‘æµç¨‹
          enableWiFiConfig()
        }
      }

      /**
       * ğŸ†• å¯ç”¨WiFié…ç½®æ­¥éª¤
       */
      function enableWiFiConfig() {
        document.getElementById('wifiSsid').disabled = false
        document.getElementById('wifiPassword').disabled = false
        document.getElementById('btnConfigWiFi').disabled = false
        log('ğŸ’¡ è¯·é…ç½®WiFiä¿¡æ¯ï¼ˆæ­¥éª¤3ï¼‰', 'info')
      }

      // ========== æ­¥éª¤3ï¼šé…ç½®WiFi ==========

      async function configureWiFi() {
        const ssid = document.getElementById('wifiSsid').value
        const password = document.getElementById('wifiPassword').value

        if (!ssid || !password) {
          showStatus('step3', 'è¯·è¾“å…¥WiFiä¿¡æ¯', 'error')
          return
        }

        log(`ğŸ“¡ æ­£åœ¨é€šè¿‡è“ç‰™å‘é€WiFié…ç½®: ${ssid}`)
        showStatus('step3', 'æ­£åœ¨é€šè¿‡è“ç‰™å‘é€é…ç½®...', 'info')

        try {
          // çœŸå®å‘é€ï¼šé€šè¿‡HTTPï¼ˆæ¨¡æ‹Ÿè“ç‰™ï¼‰å‘é€WiFié…ç½®ç»™ç½‘å…³
          const response = await fetch('http://localhost:3002/bluetooth/configure', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              ssid: ssid,
              password: password,
            }),
          }).catch(err => {
            throw new Error('æ— æ³•è¿æ¥åˆ°ç½‘å…³ï¼ˆè“ç‰™æ–­å¼€ï¼Ÿï¼‰')
          })

          if (!response) {
            throw new Error('ç½‘å…³æ— å“åº”')
          }

          if (!response.ok) {
            throw new Error('ç½‘å…³æ‹’ç»é…ç½®: ' + response.status)
          }

          const result = await response.json()

          log('âœ… WiFié…ç½®å·²å‘é€åˆ°ç½‘å…³')
          log('â³ ç½‘å…³æ­£åœ¨è¿æ¥WiFi...')
          log('â³ ç­‰å¾…ç½‘å…³è¿æ¥MQTT...')

          showStatus('step3', 'WiFié…ç½®æˆåŠŸï¼Œç½‘å…³æ­£åœ¨è¿æ¥...', 'success')

          await sleep(3000) // ç­‰å¾…ç½‘å…³è¿æ¥ï¼ˆè§‚å¯Ÿç½‘å…³æ¨¡æ‹Ÿå™¨æ—¥å¿—ï¼‰

          log('ğŸ’¡ æŸ¥çœ‹ç½‘å…³æ¨¡æ‹Ÿå™¨çª—å£ï¼Œåº”è¯¥çœ‹åˆ°WiFiå’ŒMQTTè¿æ¥æ—¥å¿—')
          log('ğŸ’¡ ç­‰ç½‘å…³è¿æ¥æˆåŠŸåï¼Œè¾“å…¥Tokenå¹¶å¼€å§‹æ£€æµ‹')

          showStatus('step3', 'é…ç½®å®Œæˆï¼è¯·è¾“å…¥Tokenåå¼€å§‹æ£€æµ‹', 'success')

          // å¯ç”¨Tokenè¾“å…¥å’Œåœ¨çº¿æ£€æµ‹
          document.getElementById('jwtToken').disabled = false
          document.getElementById('btnWaitOnline').disabled = false
          completeStep(3)
        } catch (error) {
          console.error('WiFié…ç½®é”™è¯¯:', error)
          log(`âŒ WiFié…ç½®å¤±è´¥: ${error.message}`, 'error')
          log('ğŸ’¡ è¯·æ£€æŸ¥ç½‘å…³æ¨¡æ‹Ÿå™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ', 'warning')
          showStatus('step3', `é…ç½®å¤±è´¥: ${error.message}`, 'error')
        }
      }

      // ========== æ­¥éª¤4ï¼šç­‰å¾…ä¸Šçº¿ ==========

      async function waitForOnline() {
        // æ£€æŸ¥æ˜¯å¦å·²è¾“å…¥token
        const token = document.getElementById('jwtToken').value
        if (!token) {
          showStatus('step4', 'è¯·å…ˆè¾“å…¥JWT Token', 'error')
          log('âŒ ç¼ºå°‘JWT Token', 'error')
          return
        }

        log('ğŸ” å¼€å§‹è½®è¯¢æ£€æµ‹ç½‘å…³åœ¨çº¿çŠ¶æ€...')
        showStatus('step4', 'æ­£åœ¨æ£€æµ‹...', 'info')

        document.getElementById('btnWaitOnline').disabled = true

        let attempts = 0
        const maxAttempts = 30

        // æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„è½®è¯¢
        if (pollingInterval) {
          clearInterval(pollingInterval)
          pollingInterval = null
        }

        pollingInterval = setInterval(async () => {
          attempts++

          try {
            const response = await fetch(`${API_BASE}/gateway/${currentGatewayId}/verify`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                authorization: `Bearer ${token}`,
              },
            }).catch(err => {
              // ç½‘ç»œé”™è¯¯å¤„ç†
              throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥: ' + err.message)
            })

            if (!response) {
              throw new Error('è¯·æ±‚å¤±è´¥ï¼Œæ— å“åº”')
            }

            // å®‰å…¨åœ°è§£æJSON
            let data
            try {
              data = await response.json()
            } catch (jsonErr) {
              throw new Error('å“åº”æ•°æ®æ ¼å¼é”™è¯¯')
            }

            if (data && data.data && data.data.isOnline) {
              clearInterval(pollingInterval)
              pollingInterval = null
              log('âœ… ç½‘å…³å·²ä¸Šçº¿ï¼')
              showStatus('step4', 'ç½‘å…³å·²ä¸Šçº¿', 'success')

              // å¯ç”¨ç»‘å®šï¼ˆtokenå·²åœ¨æ­¥éª¤3åå¯ç”¨ï¼‰
              document.getElementById('gatewayName').disabled = false
              document.getElementById('btnBind').disabled = false

              completeStep(4)
              return
            }

            log(`â³ ç¬¬ ${attempts} æ¬¡æ£€æµ‹: ç½‘å…³ç¦»çº¿`)
            showStatus('step4', `æ£€æµ‹ä¸­... (${attempts}/${maxAttempts})`, 'info')
          } catch (error) {
            console.error('è½®è¯¢é”™è¯¯:', error)
            log(`âŒ æ£€æµ‹å¤±è´¥: ${error.message}`, 'error')
            // ä¸è¦å› ä¸ºä¸€æ¬¡å¤±è´¥å°±åœæ­¢è½®è¯¢ï¼Œç»§ç»­å°è¯•
          }

          if (attempts >= maxAttempts) {
            if (pollingInterval) {
              clearInterval(pollingInterval)
              pollingInterval = null
            }
            log('âŒ è¶…æ—¶: ç½‘å…³æœªä¸Šçº¿', 'error')
            showStatus('step4', 'è¶…æ—¶ï¼è¯·æ£€æŸ¥ç½‘å…³æ¨¡æ‹Ÿè„šæœ¬æ˜¯å¦è¿è¡Œ', 'error')
            document.getElementById('btnWaitOnline').disabled = false
          }
        }, 2000) // æ¯2ç§’æ£€æµ‹ä¸€æ¬¡
      }

      // ========== æ­¥éª¤5ï¼šç»‘å®šç½‘å…³ ==========

      async function bindGateway() {
        const token = document.getElementById('jwtToken').value
        const name = document.getElementById('gatewayName').value || 'æµ‹è¯•ç½‘å…³'

        if (!token) {
          showStatus('step5', 'è¯·è¾“å…¥JWT token', 'error')
          log('âŒ ç¼ºå°‘JWT token', 'error')
          return
        }

        if (!currentGatewayId) {
          showStatus('step5', 'ç½‘å…³IDä¸¢å¤±ï¼Œè¯·é‡æ–°æ‰«æ', 'error')
          log('âŒ ç½‘å…³IDä¸¢å¤±', 'error')
          return
        }

        log(`ğŸ”— æ­£åœ¨ç»‘å®šç½‘å…³: ${currentGatewayId}`)
        showStatus('step5', 'æ­£åœ¨ç»‘å®š...', 'info')

        try {
          const response = await fetch(`${API_BASE}/gateway/bind`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              gatewayId: currentGatewayId,
              name: name,
            }),
          }).catch(err => {
            throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥: ' + err.message)
          })

          if (!response) {
            throw new Error('è¯·æ±‚å¤±è´¥ï¼Œæ— å“åº”')
          }

          let data
          try {
            data = await response.json()
          } catch (jsonErr) {
            throw new Error('æœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯')
          }

          if (response.ok && data.code === 200) {
            log('ğŸ‰ ç½‘å…³ç»‘å®šæˆåŠŸï¼')
            if (data.data) {
              log(`ğŸ“ ç½‘å…³åç§°: ${data.data.name}`)
              log(`ğŸ†” ç½‘å…³ID: ${data.data.gatewayId}`)
              log(`ğŸŸ¢ åœ¨çº¿çŠ¶æ€: ${data.data.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}`)
            }

            showStatus('step5', 'ç»‘å®šæˆåŠŸï¼é…ç½‘æµç¨‹å®Œæˆ ğŸ‰', 'success')
            completeStep(5)

            // ğŸ†• å¯ç”¨æ­¥éª¤6ï¼ˆæ·»åŠ å­è®¾å¤‡ï¼‰
            document.getElementById('btnStartPairing').disabled = false
            log('ğŸ’¡ ç°åœ¨å¯ä»¥æ·»åŠ å­è®¾å¤‡äº†ï¼ˆæ­¥éª¤6ï¼‰', 'success')
          } else {
            log(`âŒ ç»‘å®šå¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            showStatus('step5', `ç»‘å®šå¤±è´¥: ${data.message || 'æœåŠ¡å™¨é”™è¯¯'}`, 'error')
          }
        } catch (error) {
          console.error('ç»‘å®šé”™è¯¯:', error)
          log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error')
          showStatus('step5', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error')
        }
      }

      // ========== ğŸ†• æ­¥éª¤6ï¼šæ·»åŠ å­è®¾å¤‡ ==========

      /**
       * å¼€å§‹é…å¯¹å­è®¾å¤‡
       */
      async function startPairing() {
        const token = document.getElementById('jwtToken').value

        if (!token) {
          showStatus('step6', 'è¯·å…ˆè¾“å…¥Token', 'error')
          log('âŒ ç¼ºå°‘JWT Token', 'error')
          return
        }

        if (!currentGatewayId) {
          showStatus('step6', 'ç½‘å…³IDä¸¢å¤±ï¼Œè¯·é‡æ–°æ‰«æ', 'error')
          log('âŒ ç½‘å…³IDä¸¢å¤±', 'error')
          return
        }

        log('ğŸ” æ­£åœ¨æ£€æŸ¥ç½‘å…³çŠ¶æ€...')
        showStatus('step6', 'æ­£åœ¨æ£€æŸ¥ç½‘å…³çŠ¶æ€...', 'info')

        try {
          // å…ˆéªŒè¯ç½‘å…³æ˜¯å¦å·²ç»‘å®šä¸”åœ¨çº¿
          const verifyResponse = await fetch(`${API_BASE}/gateway/${currentGatewayId}/verify`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              authorization: `Bearer ${token}`,
            },
          })

          const verifyData = await verifyResponse.json()

          if (!verifyResponse.ok || !verifyData.data) {
            throw new Error('æ— æ³•éªŒè¯ç½‘å…³çŠ¶æ€')
          }

          const { exists, isOnline, isBound } = verifyData.data

          // æ£€æŸ¥ç½‘å…³æ˜¯å¦å­˜åœ¨
          if (!exists) {
            log('âŒ ç½‘å…³ä¸å­˜åœ¨', 'error')
            showStatus('step6', 'ç½‘å…³ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®Œæˆé…ç½‘', 'error')
            return
          }

          // æ£€æŸ¥ç½‘å…³æ˜¯å¦å·²ç»‘å®š
          if (!isBound) {
            log('âŒ ç½‘å…³æœªç»‘å®šç”¨æˆ·', 'error')
            showStatus('step6', 'ç½‘å…³æœªç»‘å®šç”¨æˆ·ï¼Œè¯·å…ˆå®Œæˆæ­¥éª¤5', 'error')
            return
          }

          // æ£€æŸ¥ç½‘å…³æ˜¯å¦åœ¨çº¿
          if (!isOnline) {
            log('âŒ ç½‘å…³ç¦»çº¿ï¼Œæ— æ³•æ·»åŠ å­è®¾å¤‡', 'error')
            showStatus('step6', 'ç½‘å…³ç¦»çº¿ï¼Œè¯·ç¡®ä¿ç½‘å…³å·²è¿æ¥', 'error')
            return
          }

          log('âœ… ç½‘å…³çŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥æ·»åŠ å­è®¾å¤‡')
          log('ğŸ”„ æ­£åœ¨å‘ç½‘å…³å‘é€é…å¯¹å‘½ä»¤...')

          // è°ƒç”¨APIå¼€å§‹é…å¯¹
          const response = await fetch(`${API_BASE}/gateway/${currentGatewayId}/pairing_start`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              authorization: `Bearer ${token}`,
            },
          })

          const data = await response.json()

          if (response.ok && data.code === 200) {
            log('âœ… é…å¯¹å‘½ä»¤å·²å‘é€ï¼')
            log('ğŸ’¡ ç½‘å…³å·²è¿›å…¥é…å¯¹æ¨¡å¼')
            log('ğŸ” ç½‘å…³æ­£åœ¨æ‰«æå‘¨å›´çš„å­è®¾å¤‡ï¼ˆçº¦15ç§’ï¼‰...')
            log('ğŸ’¡ æ‰«æå®Œæˆåå°†ä¸€æ¬¡æ€§ä¸ŠæŠ¥æ‰€æœ‰å‘ç°çš„å­è®¾å¤‡')
            log('ğŸ’¡ è§‚å¯Ÿç½‘å…³æ¨¡æ‹Ÿå™¨çª—å£ï¼ŒæŸ¥çœ‹æ‰«æè¿›åº¦')
            log('ğŸ’¡ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¾“å…¥ "pair" æ·»åŠ å­è®¾å¤‡ï¼Œè¾“å…¥ "finish" ç«‹å³å®Œæˆæ‰«æ')

            showStatus('step6', 'ğŸ” ç½‘å…³æ­£åœ¨æ‰«æå­è®¾å¤‡ï¼ˆçº¦15ç§’ï¼‰ï¼Œè¯·ç­‰å¾…...', 'success')

            // å¯ç”¨åœæ­¢é…å¯¹æŒ‰é’®
            document.getElementById('btnStopPairing').disabled = false
            document.getElementById('btnStartPairing').disabled = true

            // å¼€å§‹è½®è¯¢æŸ¥è¯¢å­è®¾å¤‡åˆ—è¡¨
            startPollingSubDevices()
          } else {
            log(`âŒ å¯åŠ¨é…å¯¹å¤±è´¥: ${data.message}`, 'error')
            showStatus('step6', `å¯åŠ¨é…å¯¹å¤±è´¥: ${data.message}`, 'error')
          }
        } catch (error) {
          console.error('å¯åŠ¨é…å¯¹é”™è¯¯:', error)
          log(`âŒ å¯åŠ¨é…å¯¹å¤±è´¥: ${error.message}`, 'error')
          showStatus('step6', `å¯åŠ¨é…å¯¹å¤±è´¥: ${error.message}`, 'error')
        }
      }

      /**
       * åœæ­¢é…å¯¹å­è®¾å¤‡
       */
      async function stopPairing() {
        const token = document.getElementById('jwtToken').value

        if (!token) {
          return
        }

        log('ğŸ›‘ æ­£åœ¨åœæ­¢é…å¯¹...')

        try {
          const response = await fetch(`${API_BASE}/gateway/${currentGatewayId}/pairing_stop`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              authorization: `Bearer ${token}`,
            },
          })

          const data = await response.json()

          if (response.ok && data.code === 200) {
            log('âœ… å·²åœæ­¢é…å¯¹')
            showStatus('step6', 'å·²åœæ­¢é…å¯¹', 'success')

            // åœæ­¢è½®è¯¢
            stopPollingSubDevices()

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            document.getElementById('btnStartPairing').disabled = false
            document.getElementById('btnStopPairing').disabled = true
          } else {
            log(`âŒ åœæ­¢é…å¯¹å¤±è´¥: ${data.message}`, 'error')
          }
        } catch (error) {
          console.error('åœæ­¢é…å¯¹é”™è¯¯:', error)
          log(`âŒ åœæ­¢é…å¯¹å¤±è´¥: ${error.message}`, 'error')
        }
      }

      /**
       * å¼€å§‹è½®è¯¢å­è®¾å¤‡åˆ—è¡¨
       */
      function startPollingSubDevices() {
        const token = document.getElementById('jwtToken').value

        // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
        if (pairingPollingInterval) {
          clearInterval(pairingPollingInterval)
        }

        let lastCount = 0

        pairingPollingInterval = setInterval(async () => {
          try {
            const response = await fetch(`${API_BASE}/gateway/${currentGatewayId}/devices`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                authorization: `Bearer ${token}`,
              },
            })

            const data = await response.json()

            if (response.ok && data.code === 200 && Array.isArray(data.data)) {
              const devices = data.data

              // å¦‚æœå­è®¾å¤‡æ•°é‡æœ‰å˜åŒ–ï¼Œæ›´æ–°æ˜¾ç¤º
              if (devices.length !== lastCount) {
                lastCount = devices.length
                log(`ğŸ“‹ å½“å‰å·²é…å¯¹ ${devices.length} ä¸ªå­è®¾å¤‡`)

                // æ˜¾ç¤ºå­è®¾å¤‡åˆ—è¡¨
                displaySubDevices(devices)
              }
            }
          } catch (error) {
            console.error('æŸ¥è¯¢å­è®¾å¤‡åˆ—è¡¨é”™è¯¯:', error)
          }
        }, 2000) // æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡
      }

      /**
       * åœæ­¢è½®è¯¢å­è®¾å¤‡åˆ—è¡¨
       */
      function stopPollingSubDevices() {
        if (pairingPollingInterval) {
          clearInterval(pairingPollingInterval)
          pairingPollingInterval = null
        }
      }

      /**
       * æ˜¾ç¤ºå­è®¾å¤‡åˆ—è¡¨
       */
      function displaySubDevices(devices) {
        const container = document.getElementById('subDeviceList')

        if (devices.length === 0) {
          container.innerHTML = '<div class="status info">æš‚æ— å­è®¾å¤‡</div>'
          return
        }

        let html = '<div class="status success">å·²é…å¯¹çš„å­è®¾å¤‡ï¼š</div>'
        html += '<div style="margin-top: 10px">'

        devices.forEach((device, index) => {
          html += `
            <div style="padding: 10px; background: #f5f5f5; border-radius: 5px; margin-bottom: 10px">
              <strong>${index + 1}. ${device.name || device.timerId}</strong><br>
              <small>ID: ${device.timerId}</small><br>
              <small>ç±»å‹: ${device.type || 'valve_single'}</small><br>
              <small>çŠ¶æ€: ${device.online ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿'}</small>
            </div>
          `
        })

        html += '</div>'
        container.innerHTML = html
      }

      // ========== åˆå§‹åŒ– ==========

      window.onload = function () {
        log('âœ… å‰ç«¯æ¨¡æ‹Ÿå™¨å·²å°±ç»ª')

        // è‡ªåŠ¨å¡«å……çœŸå®Tokenï¼ˆå¦‚æœé…ç½®äº†ï¼‰- åŒæ—¶å¡«å……ä¸¤ä¸ªè¾“å…¥æ¡†
        if (REAL_TOKEN) {
          document.getElementById('jwtToken').value = REAL_TOKEN
          document.getElementById('jwtTokenEarly').value = REAL_TOKEN
          log('ğŸ”‘ å·²è‡ªåŠ¨å¡«å……çœŸå®ç”¨æˆ·Token (qumeng039@126.com)', 'success')
          log('   Token: ' + REAL_TOKEN.substring(0, 50) + '...', 'info')
        }

        // ç›‘å¬Tokenè¾“å…¥æ¡†å˜åŒ–ï¼Œä¿æŒåŒæ­¥
        document.getElementById('jwtTokenEarly').addEventListener('input', function () {
          document.getElementById('jwtToken').value = this.value
        })
        document.getElementById('jwtToken').addEventListener('input', function () {
          document.getElementById('jwtTokenEarly').value = this.value
        })

        // é˜»æ­¢æ‰€æœ‰è¾“å…¥æ¡†çš„Enteré”®æäº¤è¡¨å•ï¼ˆé˜²æ­¢é¡µé¢åˆ·æ–°ï¼‰
        document.querySelectorAll('input').forEach(input => {
          input.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
              event.preventDefault()
              log('ğŸ’¡ æç¤ºï¼šæŒ‰Enteré”®æ— æ•ˆï¼Œè¯·ç‚¹å‡»æŒ‰é’®ç»§ç»­', 'warning')
            }
          })
        })

        log('ğŸ“Œ æ™ºèƒ½é…ç½‘æµç¨‹ï¼š')
        log('   âœ… é¦–æ¬¡é…ç½‘ï¼šå®Œæ•´èµ°å®Œ5æ­¥ï¼ˆæ‰«æ â†’ è¯»å– â†’ é…ç½‘ â†’ ä¸Šçº¿ â†’ ç»‘å®šï¼‰')
        log('   âœ… å·²ç»‘å®šç½‘å…³ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶æç¤ºï¼ˆæ— éœ€é‡å¤é…ç½‘å’Œç»‘å®šï¼‰')
        log('')
        log('ğŸ“‹ æ“ä½œæ­¥éª¤ï¼š')
        log('   1. æ‰«æè“ç‰™è®¾å¤‡')
        log('   2. è¯»å–ç½‘å…³IDï¼ˆè¾“å…¥Tokenå¯æ£€æŸ¥ç»‘å®šçŠ¶æ€ï¼‰')
        log('   3. é…ç½®WiFiï¼ˆå¦‚ç½‘å…³å·²ç»‘å®šå°†è‡ªåŠ¨è·³è¿‡ï¼‰')
        log('   4. æ£€æµ‹ç½‘å…³ä¸Šçº¿')
        log('   5. ç»‘å®šç½‘å…³åˆ°ç”¨æˆ·')
        log('')
        log('ğŸ’¡ æç¤ºï¼šç½‘å…³ç»‘å®šåä¼šè‡ªåŠ¨é€šè¿‡å·²å­˜å‚¨çš„WiFiä¿¡æ¯ä¸Šçº¿')
      }

      // æ¸…ç†
      window.onbeforeunload = function () {
        if (pollingInterval) {
          clearInterval(pollingInterval)
        }
      }
    </script>
  </body>
</html>
