services:
  # Redis 缓存服务
  redis:
    image: redis:7-alpine
    container_name: timer-mqtt-redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 3s
      retries: 5

  # RedisInsight 可视化管理工具
  redisinsight:
    image: redis/redisinsight:latest
    container_name: timer-mqtt-redisinsight
    restart: unless-stopped
    ports:
      - '5540:5540'
    volumes:
      - redisinsight-data:/data
    networks:
      - app-network
    depends_on:
      - redis

  # 主应用
  timer-mqtt:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: timer-mqtt
    restart: unless-stopped
    ports:
      - '8018:8018' # HTTP API 端口
      - '1885:1885' # MQTT 端口
      - '8445:8445' # MQTT PSK 端口
    environment:
      - NODE_ENV=production
    volumes:
      - ./logs:/app/logs # 挂载日志目录到主机
      - ./.env.production:/app/.env.production # 挂载环境变量文件（动态更新）
    networks:
      - app-network
    depends_on:
      redis:
        condition: service_healthy
    # 如果需要等待 MongoDB 启动，可以添加 depends_on
    # depends_on:
    #   - mongodb

networks:
  app-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
  redisinsight-data:
    driver: local
