worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       D:/nginx-1.24.0/conf/mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    # 访问日志
    access_log D:/nginx-1.24.0/logs/access.log;
    # 错误日志
    error_log D:/nginx-1.24.0/logs/error.log debug;
    # 上游服务器定义
    upstream soildrops_api {
        server 127.0.0.1:3001;  # SOILDROPS-API
    }

    upstream timer_mqtt {
        server 127.0.0.1:8018;  # TIMER-MQTT
    }

    server {
        listen       80;                    # Nginx监听80端口
        server_name  localhost;             # 域名（开发环境用localhost）

        # 设置客户端请求体大小限制
        client_max_body_size 10M;

        # CORS 由后端服务器处理，Nginx 不需要设置
        # 这样避免重复的 CORS 头导致浏览器拒绝请求

        # ========== SOILDROPS-API 路由 ==========
        # 所有 /apiv3/ 开头的请求转发到 SOILDROPS-API
        location /apiv3/ {
            proxy_pass http://soildrops_api/apiv3/;

            # 传递原始请求信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        location /api/auth/ {
            proxy_pass http://soildrops_api/api/auth/;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # ========== TIMER-MQTT 路由 ==========
        # 所有 /api/timer/ 开头的请求转发到 TIMER-MQTT
        # 例如: /api/timer/xxx → http://127.0.0.1:8018/api/xxx
        location /apiv3/timer/ {
            proxy_pass http://timer_mqtt/api/;

            # 传递原始请求信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # ========== 静态资源路由 ==========
        # 上传的文件和图片
        location /upload/ {
            proxy_pass http://soildrops_api/upload/;
        }

        location /image/ {
            proxy_pass http://soildrops_api/image/;
        }

        # ========== 健康检查路由 ==========
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        # 默认404页面
        location / {
            return 404 '{"error": "Not Found", "message": "请使用正确的API路径"}';
            add_header Content-Type application/json;
        }
    }
}