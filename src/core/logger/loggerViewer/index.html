<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soildrops Timer Logs File</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h1 data-i18n="title">ğŸ“Š æ—¥å¿—æŸ¥çœ‹å™¨</h1>
            <p data-i18n="subtitle">å®æ—¶ç›‘æ§ç³»ç»Ÿæ—¥å¿— Â· HTTP & MQTT & Sync</p>
          </div>
          <button class="lang-btn" onclick="toggleLanguage()" title="åˆ‡æ¢è¯­è¨€ / Switch Language">
            <span id="langText">EN</span>
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3 data-i18n="stat.totalFiles">æ€»æ–‡ä»¶æ•°</h3>
          <div class="value" id="totalFiles">-</div>
          <div class="sub-value" id="totalRecords">- æ¡è®°å½•</div>
        </div>
        <div class="stat-card">
          <h3 data-i18n="stat.httpLogs">HTTP æ—¥å¿—</h3>
          <div class="value" id="httpFiles">-</div>
          <div class="sub-value" id="httpRecords">- æ¡è®°å½•</div>
        </div>
        <div class="stat-card">
          <h3 data-i18n="stat.mqttLogs">MQTT æ—¥å¿—</h3>
          <div class="value" id="mqttFiles">-</div>
          <div class="sub-value" id="mqttRecords">- æ¡è®°å½•</div>
        </div>
        <div class="stat-card">
          <h3 data-i18n="stat.syncLogs">åŒæ­¥æ—¥å¿—</h3>
          <div class="value" id="syncFiles">-</div>
          <div class="sub-value" id="syncRecords">- æ¡è®°å½•</div>
        </div>
        <div class="stat-card">
          <h3 data-i18n="stat.errorLogs">é”™è¯¯æ—¥å¿—</h3>
          <div class="value" id="errorFiles">-</div>
          <div class="sub-value" id="errorRecords">- æ¡è®°å½•</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <label data-i18n="fileSelector.label">ğŸ“ é€‰æ‹©æ—¥å¿—æ–‡ä»¶</label>
          <select id="fileSelector">
            <option value="" data-i18n="fileSelector.viewAll">æŸ¥çœ‹æ‰€æœ‰æœ€è¿‘æ—¥å¿—</option>
          </select>
        </div>
        <div class="controls">
          <div class="controls-row">
            <select id="logType">
              <option value="" data-i18n="logType.all">å…¨éƒ¨ç±»å‹</option>
              <option value="http" data-i18n="logType.http">HTTP æ—¥å¿—</option>
              <option value="mqtt" data-i18n="logType.mqtt">MQTT æ—¥å¿—</option>
              <option value="sync" data-i18n="logType.sync">åŒæ­¥æ—¥å¿—</option>
              <option value="error" data-i18n="logType.error">é”™è¯¯æ—¥å¿—</option>
            </select>
            <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æ—¥å¿—å†…å®¹..." data-i18n-placeholder="searchPlaceholder" />
            <button class="btn btn-primary" onclick="searchLogs()" data-i18n="button.search">æœç´¢</button>
            <button class="btn btn-secondary" onclick="loadRecentLogs()" data-i18n="button.refresh">åˆ·æ–°</button>
          </div>
        </div>
        <div id="logsContent" class="loading" data-i18n="loading">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <button class="refresh-btn" onclick="loadRecentLogs()" title="åˆ·æ–°æ—¥å¿—" data-i18n-title="refreshTitle">âŸ³</button>

    <script>
      /* ---- å›½é™…åŒ–é…ç½® ---- */
      const i18n = {
        zh: {
          title: 'ğŸ“Š æ—¥å¿—æŸ¥çœ‹å™¨',
          subtitle: 'å®æ—¶ç›‘æ§ç³»ç»Ÿæ—¥å¿— Â· HTTP & MQTT & Sync',
          stat: {
            totalFiles: 'æ€»æ–‡ä»¶æ•°',
            httpLogs: 'HTTP æ—¥å¿—',
            mqttLogs: 'MQTT æ—¥å¿—',
            syncLogs: 'åŒæ­¥æ—¥å¿—',
            errorLogs: 'é”™è¯¯æ—¥å¿—'
          },
          fileSelector: {
            label: 'ğŸ“ é€‰æ‹©æ—¥å¿—æ–‡ä»¶',
            viewAll: 'æŸ¥çœ‹æ‰€æœ‰æœ€è¿‘æ—¥å¿—'
          },
          logType: {
            all: 'å…¨éƒ¨ç±»å‹',
            http: 'HTTP æ—¥å¿—',
            mqtt: 'MQTT æ—¥å¿—',
            sync: 'åŒæ­¥æ—¥å¿—',
            error: 'é”™è¯¯æ—¥å¿—'
          },
          searchPlaceholder: 'ğŸ” æœç´¢æ—¥å¿—å†…å®¹...',
          button: {
            search: 'æœç´¢',
            refresh: 'åˆ·æ–°'
          },
          loading: 'åŠ è½½ä¸­...',
          refreshTitle: 'åˆ·æ–°æ—¥å¿—',
          records: 'æ¡è®°å½•',
          noLogs: 'ğŸ“­ æš‚æ— æ—¥å¿—',
          loadFailed: 'âŒ åŠ è½½å¤±è´¥',
          loadFileFailed: 'âŒ åŠ è½½æ–‡ä»¶å¤±è´¥',
          searchFailed: 'âŒ æœç´¢å¤±è´¥'
        },
        en: {
          title: 'ğŸ“Š Log Viewer',
          subtitle: 'Real-time System Logs Monitor Â· HTTP & MQTT & Sync',
          stat: {
            totalFiles: 'Total Files',
            httpLogs: 'HTTP Logs',
            mqttLogs: 'MQTT Logs',
            syncLogs: 'Sync Logs',
            errorLogs: 'Error Logs'
          },
          fileSelector: {
            label: 'ğŸ“ Select Log File',
            viewAll: 'View All Recent Logs'
          },
          logType: {
            all: 'All Types',
            http: 'HTTP Logs',
            mqtt: 'MQTT Logs',
            sync: 'Sync Logs',
            error: 'Error Logs'
          },
          searchPlaceholder: 'ğŸ” Search log content...',
          button: {
            search: 'Search',
            refresh: 'Refresh'
          },
          loading: 'Loading...',
          refreshTitle: 'Refresh logs',
          records: 'records',
          noLogs: 'ğŸ“­ No logs',
          loadFailed: 'âŒ Load failed',
          loadFileFailed: 'âŒ Failed to load file',
          searchFailed: 'âŒ Search failed'
        }
      }

      let currentLang = localStorage.getItem('logViewerLang') || 'zh'

      function toggleLanguage() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh'
        localStorage.setItem('logViewerLang', currentLang)
        applyLanguage()
        loadStats()
        loadFileList()
      }

      function applyLanguage() {
        const t = i18n[currentLang]
        document.getElementById('langText').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­æ–‡'

        // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-i18n å±æ€§çš„å…ƒç´ 
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n')
          const keys = key.split('.')
          let value = t
          for (const k of keys) {
            value = value[k]
          }
          el.textContent = value
        })

        // æ›´æ–°å ä½ç¬¦
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          const key = el.getAttribute('data-i18n-placeholder')
          el.placeholder = t[key]
        })

        // æ›´æ–°titleå±æ€§
        document.querySelectorAll('[data-i18n-title]').forEach(el => {
          const key = el.getAttribute('data-i18n-title')
          el.title = t[key]
        })
      }

      function getI18nText(key) {
        return i18n[currentLang][key]
      }

      /* ---- å·¥å…·å‡½æ•° ---- */
      const escapeHtml = text => {
        const d = document.createElement('div')
        d.textContent = text
        return d.innerHTML
      }
      const formatTimestamp = ts => new Date(ts).toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US', { hour12: false })

      // é«˜äº®json
      function syntaxHighlight(json) {
        let str = typeof json === 'string' ? json : JSON.stringify(json, null, 2)
        str = str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        str = str.replace(/"(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(?=\s*[,}\]])/g, '<span class="json-string">$&</span>')
        str = str.replace(/"(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(?=\s*:)/g, '<span class="json-key">$&</span>')
        str = str.replace(/\b(-?\d+(?:\.\d+)?([eE][+-]?\d+)?)\b/g, '<span class="json-number">$1</span>')
        str = str.replace(/\b(true|false|null)\b/g, '<span class="json-boolean">$&</span>')
        return str
      }

      /* ---- API è°ƒç”¨ ---- */
      async function loadStats() {
        try {
          const res = await fetch('/logs/api/stats')
          const json = await res.json()
          if (json.code === 200) {
            const s = json.data
            // æ›´æ–°æ–‡ä»¶æ•°
            ;['totalFiles', 'httpFiles', 'mqttFiles', 'syncFiles', 'errorFiles'].forEach(
              k => (document.getElementById(k).textContent = s[k]),
            )
            // æ›´æ–°è®°å½•æ•°
            const formatNumber = num => num.toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US')
            const recordsText = getI18nText('records')
            document.getElementById('totalRecords').textContent = `${formatNumber(s.totalRecords || 0)} ${recordsText}`
            document.getElementById('httpRecords').textContent = `${formatNumber(s.httpRecords || 0)} ${recordsText}`
            document.getElementById('mqttRecords').textContent = `${formatNumber(s.mqttRecords || 0)} ${recordsText}`
            document.getElementById('syncRecords').textContent = `${formatNumber(s.syncRecords || 0)} ${recordsText}`
            document.getElementById('errorRecords').textContent = `${formatNumber(s.errorRecords || 0)} ${recordsText}`
          }
        } catch (e) {
          console.error('stats error', e)
        }
      }
      async function loadFileList() {
        try {
          const res = await fetch('/logs/api/files')
          const json = await res.json()
          if (json.code === 200) {
            const sel = document.getElementById('fileSelector')
            const defaultOption = document.createElement('option')
            defaultOption.value = ''
            defaultOption.setAttribute('data-i18n', 'fileSelector.viewAll')
            defaultOption.textContent = getI18nText('fileSelector').viewAll
            sel.innerHTML = ''
            sel.appendChild(defaultOption)
            json.data.forEach(f => {
              const opt = document.createElement('option')
              opt.value = f.name
              opt.textContent = `${f.name} (${(f.size / 1024).toFixed(2)} KB - ${new Date(f.modified).toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US')})`
              sel.appendChild(opt)
            })
          }
        } catch (e) {
          console.error('file list error', e)
        }
      }
      async function loadRecentLogs() {
        const type = document.getElementById('logType').value
        const filename = document.getElementById('fileSelector').value
        if (filename) return loadFileContent(filename)
        const url = type ? `/logs/api/recent?type=${type}&limit=200` : '/logs/api/recent?limit=200'
        try {
          const res = await fetch(url)
          const json = await res.json()
          if (json.code === 200) displayLogs(json.data)
        } catch (e) {
          document.getElementById('logsContent').innerHTML = `<div class="empty">${getI18nText('loadFailed')}</div>`
        }
      }
      async function loadFileContent(filename) {
        try {
          const res = await fetch(`/logs/api/file?filename=${encodeURIComponent(filename)}&limit=500`)
          const json = await res.json()
          if (json.code === 200) displayLogs(json.data)
        } catch (e) {
          document.getElementById('logsContent').innerHTML = `<div class="empty">${getI18nText('loadFileFailed')}</div>`
        }
      }
      async function searchLogs() {
        const kw = document.getElementById('searchInput').value.trim()
        const type = document.getElementById('logType').value
        if (!kw) return loadRecentLogs()
        try {
          const url = type
            ? `/logs/api/search?keyword=${encodeURIComponent(kw)}&type=${type}`
            : `/logs/api/search?keyword=${encodeURIComponent(kw)}`
          const res = await fetch(url)
          const json = await res.json()
          if (json.code === 200) displayLogs(json.data)
        } catch (e) {
          document.getElementById('logsContent').innerHTML = `<div class="empty">${getI18nText('searchFailed')}</div>`
        }
      }

      /* ---- æ¸²æŸ“ ---- */
      function displayLogs(logs) {
        const box = document.getElementById('logsContent')
        if (!logs || !logs.length) {
          box.innerHTML = `<div class="empty">${getI18nText('noLogs')}</div>`
          return
        }
        box.innerHTML = logs
          .map(
            log => `
        <div class="log-entry">
            <div class="log-header">
                <span class="log-timestamp">${formatTimestamp(log.timestamp)}</span>
                <span class="log-level ${log.level}">${log.level}</span>
                ${log.context ? `<span class="log-context">${escapeHtml(log.context)}</span>` : ''}
            </div>
            <div class="log-message">${escapeHtml(log.message)}</div>
            ${log.data ? `<div class="log-data"><pre>${syntaxHighlight(log.data)}</pre></div>` : ''}
        </div>
    `,
          )
          .join('')
      }

      document.getElementById('logType').addEventListener('change', loadRecentLogs)
      document.getElementById('fileSelector').addEventListener('change', loadRecentLogs)
      document.getElementById('searchInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') searchLogs()
      })

      // åˆå§‹åŒ–è¯­è¨€è®¾ç½®
      applyLanguage()

      loadStats()
      loadFileList()
      loadRecentLogs()
      setInterval(() => {
        if (!document.getElementById('searchInput').value) {
          loadStats()
          loadRecentLogs()
        }
      }, 30000)
    </script>
  </body>
</html>
