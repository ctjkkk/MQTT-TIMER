<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soildrops Timer Logs File</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“Š æ—¥å¿—æŸ¥çœ‹å™¨</h1>
        <p>å®æ—¶ç›‘æ§ç³»ç»Ÿæ—¥å¿— Â· HTTP & MQTT & Sync</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3>æ€»æ–‡ä»¶æ•°</h3>
          <div class="value" id="totalFiles">-</div>
          <div class="sub-value" id="totalRecords">- æ¡è®°å½•</div>
        </div>
        <div class="stat-card">
          <h3>HTTP æ—¥å¿—</h3>
          <div class="value" id="httpFiles">-</div>
          <div class="sub-value" id="httpRecords">- æ¡è®°å½•</div>
        </div>
        <div class="stat-card">
          <h3>MQTT æ—¥å¿—</h3>
          <div class="value" id="mqttFiles">-</div>
          <div class="sub-value" id="mqttRecords">- æ¡è®°å½•</div>
        </div>
        <div class="stat-card">
          <h3>åŒæ­¥æ—¥å¿—</h3>
          <div class="value" id="syncFiles">-</div>
          <div class="sub-value" id="syncRecords">- æ¡è®°å½•</div>
        </div>
        <div class="stat-card">
          <h3>é”™è¯¯æ—¥å¿—</h3>
          <div class="value" id="errorFiles">-</div>
          <div class="sub-value" id="errorRecords">- æ¡è®°å½•</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <label>ğŸ“ é€‰æ‹©æ—¥å¿—æ–‡ä»¶</label>
          <select id="fileSelector">
            <option value="">æŸ¥çœ‹æ‰€æœ‰æœ€è¿‘æ—¥å¿—</option>
          </select>
        </div>
        <div class="controls">
          <div class="controls-row">
            <select id="logType">
              <option value="">å…¨éƒ¨ç±»å‹</option>
              <option value="http">HTTP æ—¥å¿—</option>
              <option value="mqtt">MQTT æ—¥å¿—</option>
              <option value="sync">åŒæ­¥æ—¥å¿—</option>
              <option value="error">é”™è¯¯æ—¥å¿—</option>
            </select>
            <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æ—¥å¿—å†…å®¹..." />
            <button class="btn btn-primary" onclick="searchLogs()">æœç´¢</button>
            <button class="btn btn-secondary" onclick="loadRecentLogs()">åˆ·æ–°</button>
          </div>
        </div>
        <div id="logsContent" class="loading">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <button class="refresh-btn" onclick="loadRecentLogs()" title="åˆ·æ–°æ—¥å¿—">âŸ³</button>

    <script>
      /* ---- å·¥å…·å‡½æ•° ---- */
      const escapeHtml = text => {
        const d = document.createElement('div')
        d.textContent = text
        return d.innerHTML
      }
      const formatTimestamp = ts => new Date(ts).toLocaleString('zh-CN', { hour12: false })

      // é«˜äº®json
      function syntaxHighlight(json) {
        let str = typeof json === 'string' ? json : JSON.stringify(json, null, 2)
        str = str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        str = str.replace(/"(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(?=\s*[,}\]])/g, '<span class="json-string">$&</span>')
        str = str.replace(/"(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(?=\s*:)/g, '<span class="json-key">$&</span>')
        str = str.replace(/\b(-?\d+(?:\.\d+)?([eE][+-]?\d+)?)\b/g, '<span class="json-number">$1</span>')
        str = str.replace(/\b(true|false|null)\b/g, '<span class="json-boolean">$&</span>')
        return str
      }

      /* ---- API è°ƒç”¨ ---- */
      async function loadStats() {
        try {
          const res = await fetch('/logs/api/stats')
          const json = await res.json()
          if (json.code === 200) {
            const s = json.data
            // æ›´æ–°æ–‡ä»¶æ•°
            ;['totalFiles', 'httpFiles', 'mqttFiles', 'syncFiles', 'errorFiles'].forEach(
              k => (document.getElementById(k).textContent = s[k]),
            )
            // æ›´æ–°è®°å½•æ•°
            const formatNumber = num => num.toLocaleString('zh-CN')
            document.getElementById('totalRecords').textContent = `${formatNumber(s.totalRecords || 0)} æ¡è®°å½•`
            document.getElementById('httpRecords').textContent = `${formatNumber(s.httpRecords || 0)} æ¡è®°å½•`
            document.getElementById('mqttRecords').textContent = `${formatNumber(s.mqttRecords || 0)} æ¡è®°å½•`
            document.getElementById('syncRecords').textContent = `${formatNumber(s.syncRecords || 0)} æ¡è®°å½•`
            document.getElementById('errorRecords').textContent = `${formatNumber(s.errorRecords || 0)} æ¡è®°å½•`
          }
        } catch (e) {
          console.error('stats error', e)
        }
      }
      async function loadFileList() {
        try {
          const res = await fetch('/logs/api/files')
          const json = await res.json()
          if (json.code === 200) {
            const sel = document.getElementById('fileSelector')
            sel.innerHTML = '<option value="">æŸ¥çœ‹æ‰€æœ‰æœ€è¿‘æ—¥å¿—</option>'
            json.data.forEach(f => {
              const opt = document.createElement('option')
              opt.value = f.name
              opt.textContent = `${f.name} (${(f.size / 1024).toFixed(2)} KB - ${new Date(f.modified).toLocaleString('zh-CN')})`
              sel.appendChild(opt)
            })
          }
        } catch (e) {
          console.error('file list error', e)
        }
      }
      async function loadRecentLogs() {
        const type = document.getElementById('logType').value
        const filename = document.getElementById('fileSelector').value
        if (filename) return loadFileContent(filename)
        const url = type ? `/logs/api/recent?type=${type}&limit=200` : '/logs/api/recent?limit=200'
        try {
          const res = await fetch(url)
          const json = await res.json()
          if (json.code === 200) displayLogs(json.data)
        } catch (e) {
          document.getElementById('logsContent').innerHTML = '<div class="empty">âŒ åŠ è½½å¤±è´¥</div>'
        }
      }
      async function loadFileContent(filename) {
        try {
          const res = await fetch(`/logs/api/file?filename=${encodeURIComponent(filename)}&limit=500`)
          const json = await res.json()
          if (json.code === 200) displayLogs(json.data)
        } catch (e) {
          document.getElementById('logsContent').innerHTML = '<div class="empty">âŒ åŠ è½½æ–‡ä»¶å¤±è´¥</div>'
        }
      }
      async function searchLogs() {
        const kw = document.getElementById('searchInput').value.trim()
        const type = document.getElementById('logType').value
        if (!kw) return loadRecentLogs()
        try {
          const url = type
            ? `/logs/api/search?keyword=${encodeURIComponent(kw)}&type=${type}`
            : `/logs/api/search?keyword=${encodeURIComponent(kw)}`
          const res = await fetch(url)
          const json = await res.json()
          if (json.code === 200) displayLogs(json.data)
        } catch (e) {
          document.getElementById('logsContent').innerHTML = '<div class="empty">âŒ æœç´¢å¤±è´¥</div>'
        }
      }

      /* ---- æ¸²æŸ“ ---- */
      function displayLogs(logs) {
        const box = document.getElementById('logsContent')
        if (!logs || !logs.length) {
          box.innerHTML = '<div class="empty">ğŸ“­ æš‚æ— æ—¥å¿—</div>'
          return
        }
        box.innerHTML = logs
          .map(
            log => `
        <div class="log-entry">
            <div class="log-header">
                <span class="log-timestamp">${formatTimestamp(log.timestamp)}</span>
                <span class="log-level ${log.level}">${log.level}</span>
                ${log.context ? `<span class="log-context">${escapeHtml(log.context)}</span>` : ''}
            </div>
            <div class="log-message">${escapeHtml(log.message)}</div>
            ${log.data ? `<div class="log-data"><pre>${syntaxHighlight(log.data)}</pre></div>` : ''}
        </div>
    `,
          )
          .join('')
      }

      document.getElementById('logType').addEventListener('change', loadRecentLogs)
      document.getElementById('fileSelector').addEventListener('change', loadRecentLogs)
      document.getElementById('searchInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') searchLogs()
      })

      loadStats()
      loadFileList()
      loadRecentLogs()
      setInterval(() => {
        if (!document.getElementById('searchInput').value) {
          loadStats()
          loadRecentLogs()
        }
      }, 30000)
    </script>
  </body>
</html>
